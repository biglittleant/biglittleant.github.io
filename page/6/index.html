<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.biglittleant.cn","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"right","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Big Little Ant">
<meta property="og:url" content="http://www.biglittleant.cn/page/6/index.html">
<meta property="og:site_name" content="Big Little Ant">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Big Little Ant">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://www.biglittleant.cn/page/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Big Little Ant</title>
  






  <script async defer data-website-id="" src=""></script>

  <script defer data-domain="" src=""></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Big Little Ant</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">不被嘲笑的梦想，是不值得去实现的</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-文章分类"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>文章分类</a></li><li class="menu-item menu-item-golang"><a href="/categories/go" rel="section"><i class="fa fa-th fa-fw"></i>Golang</a></li><li class="menu-item menu-item-kubernetes"><a href="/categories/kubernetes" rel="section"><i class="fa fa-th fa-fw"></i>Kubernetes</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-关于"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Big Little Ant</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2016/12/04/elastic-mapping/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/12/04/elastic-mapping/" class="post-title-link" itemprop="url">elasticsearch-mapping学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-12-04 18:14:15" itemprop="dateCreated datePublished" datetime="2016-12-04T18:14:15+08:00">2016-12-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-09-16 17:20:44" itemprop="dateModified" datetime="2020-09-16T17:20:44+08:00">2020-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/elastic/" itemprop="url" rel="index"><span itemprop="name">elastic</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>它类似于静态语言中的数据类型声明，比如声明一个字段为String， 以后这个变量都只能存储String类型的数据。同样的， 一个number类型的 mapping  字段只能存储number类型的数据。</p>
<h2 id="如何理解elastic中各参数的定义"><a href="#如何理解elastic中各参数的定义" class="headerlink" title="如何理解elastic中各参数的定义"></a>如何理解elastic中各参数的定义</h2><ul>
<li>index —-&gt; database</li>
<li>type  —–&gt; table</li>
<li>mapping —-&gt; 表结构</li>
</ul>
<p>默认情况不需要自定义mapping， 当新的type或者field引入时，Elasticsearch会自动创建并且注册有合理的默认值的mapping， 只有要覆盖默认值时才必须要提供mapping定义。</p>
<h2 id="mapping字段"><a href="#mapping字段" class="headerlink" title="mapping字段"></a>mapping字段</h2><h3 id="自定义Mapping"><a href="#自定义Mapping" class="headerlink" title="自定义Mapping"></a>自定义Mapping</h3><p>下面是一个简单的Mapping定义：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &#x27;http<span class="punctuation">:</span><span class="comment">//localhost:9200/test-index&#x27; -d &#x27;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span>    <span class="comment">//设置分片</span></span><br><span class="line">        <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">1</span>   <span class="comment">//设置副本集</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>   <span class="comment">// 对应type名</span></span><br><span class="line">      <span class="attr">&quot;_all&quot;</span><span class="punctuation">:</span>       <span class="punctuation">&#123;</span> <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span>  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  <span class="comment">//指定每个字段的映射类型或属性。</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span>    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span>  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span>     <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span>  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;user_id&quot;</span><span class="punctuation">:</span>  <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;not_analyzed&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span>  <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict_date_optional_time||epoch_millis&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>其中login_log是type（相当于关系数据库中的表），在login_log中我们定义了name、age、about、ip、last_time这6个列。</p>
<h4 id="type字段"><a href="#type字段" class="headerlink" title="type字段"></a>type字段</h4><p>type字段用来规定字段的数据类型。<br>Elasticsearch支持以下数据类型：</p>
<p>文本: string<br>数字: byte, short, integer, long<br>浮点数: float, double<br>布尔值: boolean<br>Date: date</p>
<h4 id="index字段"><a href="#index字段" class="headerlink" title="index字段"></a>index字段</h4><p>index 属性控制string如何被索引，它有三个可选值:</p>
<ul>
<li><p>analyzed：First analyze the string, then index it. In other words, index this field as full text.</p>
</li>
<li><p>not_analyzed：Index this field, so it is searchable, but index the value exactly as specified. Do not analyze it.</p>
</li>
<li><p>no：Don’t index this field at all. This field will not be<br>searchable.</p>
</li>
</ul>
<p>对于string类型的filed index 默认值是： analyzed.对于URL这些不需要分词的字段 ，我们可以将它设置为：not_analyzed。</p>
<h4 id="analyzer-字段"><a href="#analyzer-字段" class="headerlink" title="analyzer 字段"></a>analyzer 字段</h4><p>analyzer 字段用来指定改字段用什么分词器去分词。<br>elastic默认的分词是：standard analyzer 。<br>elastic其他分词器：whitespace, simple, or english 。<br>我们也可以自己安装指定的分词器并指定。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">\\ 指定使用ik分词器对name字段进行分词。</span><br></pre></td></tr></table></figure>

<h3 id="增加mapping字段"><a href="#增加mapping字段" class="headerlink" title="增加mapping字段"></a>增加mapping字段</h3><p>将写好的mapping字段保存到mapping.json（名字随便起）文件中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST &#x27;http://192.168.56.12:9200/test-index&#x27; --d @mapping.json</span><br></pre></td></tr></table></figure>

<h3 id="更新mapping字段"><a href="#更新mapping字段" class="headerlink" title="更新mapping字段"></a>更新mapping字段</h3><p>将新的mapping字段保存到mapping-1.json（名字随便起）文件中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST &#x27;http://192.168.56.12:9200/test-index&#x27; --d @mapping-1.json</span><br></pre></td></tr></table></figure>


<h3 id="查看mapping字段"><a href="#查看mapping字段" class="headerlink" title="查看mapping字段"></a>查看mapping字段</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &#x27;http://192.168.56.12:9200/test-index/user/_mapping?pretty&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#字段解释</span></span></span><br><span class="line">- XGET method类型</span><br><span class="line">- http://192.168.56.12:9200 elastic的搜索端口</span><br><span class="line">- test-index  索引名称。</span><br><span class="line">- user 索引的type类型。</span><br><span class="line">- _mapping?pretty pretty以人类可读的形式显示。</span><br></pre></td></tr></table></figure>

<h3 id="mapping补充"><a href="#mapping补充" class="headerlink" title="mapping补充"></a>mapping补充</h3><p>可以修改的项：</p>
<ul>
<li>增加新的类型定义</li>
<li>增加新的字段</li>
<li>增加新的分析器</li>
</ul>
<p>不允许修改的项：</p>
<ul>
<li>更改字段类型(比如文本改为数字)</li>
<li>更改存储为不存储，反之亦然</li>
<li>更改索引属性的值</li>
<li>更改已索引文档的分析器</li>
</ul>
<h3 id="线上使用mapping字段展示"><a href="#线上使用mapping字段展示" class="headerlink" title="线上使用mapping字段展示"></a>线上使用mapping字段展示</h3><p>这是一个logstash的mapping字段</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;logstash&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;template&quot;</span><span class="punctuation">:</span> <span class="string">&quot;logstash-*-*&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  <span class="comment">//配置索引的参数</span></span><br><span class="line">            <span class="attr">&quot;index.refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;index.translog.flush_threshold_ops&quot;</span><span class="punctuation">:</span> <span class="string">&quot;50000&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">// 必须字段</span></span><br><span class="line">            <span class="attr">&quot;_default_&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">//定义默认参数</span></span><br><span class="line">                <span class="attr">&quot;dynamic_templates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>  <span class="comment">// 动态字段定义</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;message_field&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;analyzed&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;omit_norms&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;raw&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                        <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span><span class="punctuation">,</span> <span class="comment">//只保留256个字符</span></span><br><span class="line">                                        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;not_analyzed&quot;</span><span class="punctuation">,</span> <span class="comment">//不分词</span></span><br><span class="line">                                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span>  <span class="comment">// 字段类型string</span></span><br><span class="line">                                        <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                                    <span class="punctuation">&#125;</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;match_mapping_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span>  <span class="comment">//匹配哪些字段</span></span><br><span class="line">                            <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;message&quot;</span> <span class="comment">// 匹配哪些名称</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;string_fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;analyzed&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;omit_norms&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;raw&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                        <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span><span class="punctuation">,</span></span><br><span class="line">                                        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;not_analyzed&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                        <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                                    <span class="punctuation">&#125;</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;match_mapping_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;geoip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;full&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;dynamic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;geo_point&quot;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dateOptionalTime&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;not_analyzed&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;@version&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;not_analyzed&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;aliases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="动态字段"><a href="#动态字段" class="headerlink" title="动态字段"></a>动态字段</h3><p>格式如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;dynamic_templates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">// 定义这是动态字段</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;integers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">//名称</span></span><br><span class="line">            <span class="attr">&quot;match_mapping_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span><span class="punctuation">,</span> <span class="comment">//匹配规则</span></span><br><span class="line">            <span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;strings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">//名称</span></span><br><span class="line">            <span class="attr">&quot;match_mapping_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span> <span class="comment">//匹配规则</span></span><br><span class="line">            <span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  <span class="comment">//过滤出一个子字段</span></span><br><span class="line">                <span class="attr">&quot;raw&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">//名字叫raw，线上会有两个字段name,name.raw ,raw 可以更好成别的字符串。</span></span><br><span class="line">                  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;not_analyzed&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


<h4 id="match、unmatch和match-mapping-type"><a href="#match、unmatch和match-mapping-type" class="headerlink" title="match、unmatch和match_mapping_type"></a>match、unmatch和match_mapping_type</h4><ul>
<li>符合 match 的规则会被匹配。</li>
<li>符合 unmatch 的规则会被忽略。</li>
<li>match_mapping_type 匹配类型。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;match_mapping_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;long_*&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;unmatch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*_text&quot;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<h4 id="match-pattern"><a href="#match-pattern" class="headerlink" title="match_pattern"></a>match_pattern</h4><ul>
<li>match_pathern 正则匹配。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;match_pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;regex&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^profit_\d+$&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="path-match-and-path-unmatch"><a href="#path-match-and-path-unmatch" class="headerlink" title="path_match and path_unmatch"></a>path_match and path_unmatch</h4><ul>
<li>path_match 路径匹配</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;dynamic_templates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;full_name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;path_match&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;name.*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;path_unmatch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*.middle&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>       <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;copy_to&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;full_name&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="name-and-dynamic-type"><a href="#name-and-dynamic-type" class="headerlink" title="{name} and {dynamic_type}"></a>{name} and {dynamic_type}</h4><ul>
<li>可以使用的变量</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;dynamic_templates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;named_analyzers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;match_mapping_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;name&#125;&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;no_doc_values&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;match_mapping_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;dynamic_type&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2016/12/03/elastic-dump/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/12/03/elastic-dump/" class="post-title-link" itemprop="url">elasticsearch-migration 在线导入导出工具</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-12-03 18:13:05" itemprop="dateCreated datePublished" datetime="2016-12-03T18:13:05+08:00">2016-12-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-09-16 17:21:13" itemprop="dateModified" datetime="2020-09-16T17:21:13+08:00">2020-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/elastic/" itemprop="url" rel="index"><span itemprop="name">elastic</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>elasticsearch 数据导入导出工具</li>
<li>支持基于HTTP导出、导入。</li>
<li>支持保存到文件。</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install elasticdump -g</span><br></pre></td></tr></table></figure>
<h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><h3 id="拷贝分词器信息"><a href="#拷贝分词器信息" class="headerlink" title="拷贝分词器信息"></a>拷贝分词器信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">elasticdump \</span><br><span class="line">--input=http://192.168.56.13:9200/thread \</span><br><span class="line">--output=http://192.168.56.12:9200/thread1 \</span><br><span class="line">--type=analyzer</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="拷贝mapping信息"><a href="#拷贝mapping信息" class="headerlink" title="拷贝mapping信息"></a>拷贝mapping信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">elasticdump \</span><br><span class="line">--input=http://192.168.56.13:9200/thread \</span><br><span class="line">--output=http://192.168.56.12:9200/thread1 \</span><br><span class="line">--type=mapping</span><br></pre></td></tr></table></figure>

<h3 id="拷贝数据"><a href="#拷贝数据" class="headerlink" title="拷贝数据"></a>拷贝数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">elasticdump \</span><br><span class="line">--input=http://192.168.56.13:9200/thread \</span><br><span class="line">--output=http://192.168.56.12:9200/thread1 \</span><br><span class="line">--type=data \</span><br><span class="line">--limit=1000</span><br></pre></td></tr></table></figure>

<blockquote>
<p>limit 设置每次拷贝多少内容，默认是100。<br>拷贝数据的同时mapping也会被拷贝。</p>
</blockquote>
<h2 id="将数据保存到本地"><a href="#将数据保存到本地" class="headerlink" title="将数据保存到本地"></a>将数据保存到本地</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">elasticdump \</span><br><span class="line">--input=http://192.168.56.13:9200/thread \</span><br><span class="line">--output=thread.json \</span><br><span class="line">--type=mapping</span><br><span class="line"></span><br><span class="line">elasticdump \</span><br><span class="line">--input=http://192.168.56.13:9200/thread \</span><br><span class="line">--output=thread-data.json \</span><br><span class="line">--type=data</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="保存到压缩文件中"><a href="#保存到压缩文件中" class="headerlink" title="保存到压缩文件中"></a>保存到压缩文件中</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Backup and index to a gzip using stdout:</span></span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=$ \</span><br><span class="line">  | gzip &gt; /data/my_index.json.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="基于搜索保存文件内容"><a href="#基于搜索保存文件内容" class="headerlink" title="基于搜索保存文件内容"></a>基于搜索保存文件内容</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=query.json \</span><br><span class="line">  --searchBody &#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;username&quot;: &quot;admin&quot;&#125;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>


<h2 id="基于全局搜索的结果保存"><a href="#基于全局搜索的结果保存" class="headerlink" title="基于全局搜索的结果保存"></a>基于全局搜索的结果保存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">elasticdump \</span><br><span class="line">  --input=http://es.com:9200/api/search \</span><br><span class="line">  --input-index=my_index/my_type \</span><br><span class="line">  --output=http://es.com:9200/api/search \</span><br><span class="line">  --output-index=my_index \</span><br><span class="line">  --type=mapping</span><br></pre></td></tr></table></figure>


<h2 id="帮助文档"><a href="#帮助文档" class="headerlink" title="帮助文档"></a>帮助文档</h2><p><a target="_blank" rel="noopener" href="https://github.com/taskrabbit/elasticsearch-dump">elastic-dump-github</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2016/12/02/curator-user/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/12/02/curator-user/" class="post-title-link" itemprop="url">curator-4.1 版本使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-12-02 18:49:28" itemprop="dateCreated datePublished" datetime="2016-12-02T18:49:28+08:00">2016-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-09-16 17:30:18" itemprop="dateModified" datetime="2020-09-16T17:30:18+08:00">2020-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/elastic/" itemprop="url" rel="index"><span itemprop="name">elastic</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>旧版使用<code>--host</code>的选项来操作elastic。新版使用接YAML的配置文件来定义配置文件。</p>
<h2 id="安装方法"><a href="#安装方法" class="headerlink" title="安装方法"></a>安装方法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install python-pip  -y</span><br><span class="line">pip install --upgrade pip</span><br><span class="line">pip install elasticsearch-curator -y</span><br></pre></td></tr></table></figure>

<p>命令格式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curator --<span class="built_in">help</span></span></span><br><span class="line">Usage: curator [OPTIONS] ACTION_FILE</span><br><span class="line">  Curator for Elasticsearch indices.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  --config PATH  Path to configuration file. Default: ~/.curator/curator.yml</span><br><span class="line">  --dry-run      Do not perform any changes.</span><br><span class="line">  --version      Show the version and exit.</span><br><span class="line">  --help         Show this message and exit</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment">## 实例</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment"># 编写curator.yml(服务器的配置文件)</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment"># 编写action.yml（执行的命令）</span></span></span><br><span class="line">   /bin/curator --config curator.yml action.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="编写服务器配置文件"><a href="#编写服务器配置文件" class="headerlink" title="编写服务器配置文件"></a>编写服务器配置文件</h3><p>vim curator.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">client:</span> <span class="comment">##配置要连接的客户端</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.11</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9200</span></span><br><span class="line">  <span class="attr">url_prefix:</span></span><br><span class="line">  <span class="attr">use_ssl:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">certificate:</span></span><br><span class="line">  <span class="attr">client_cert:</span></span><br><span class="line">  <span class="attr">client_key:</span></span><br><span class="line">  <span class="attr">ssl_no_validate:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">http_auth:</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">master_only:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span> <span class="comment">##配置显示日志的信息</span></span><br><span class="line">  <span class="attr">loglevel:</span> <span class="string">INFO</span></span><br><span class="line">  <span class="attr">logfile:</span></span><br><span class="line">  <span class="attr">logformat:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">blacklist:</span> [<span class="string">&#x27;elasticsearch&#x27;</span>, <span class="string">&#x27;urllib3&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="删除五天前的log"><a href="#删除五天前的log" class="headerlink" title="删除五天前的log"></a>删除五天前的log</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">actions:</span></span><br><span class="line">  <span class="attr">1:</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">delete_indices</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&gt;-</span></span><br><span class="line"><span class="string">      Delete indices older than 45 days (based on index name), for logstash-</span></span><br><span class="line"><span class="string">      prefixed indices. Ignore the error if the filter does not result in an</span></span><br><span class="line"><span class="string">      actionable list of indices (ignore_empty_list) and exit cleanly.</span></span><br><span class="line"><span class="string"></span>    <span class="attr">options:</span></span><br><span class="line">      <span class="attr">ignore_empty_list:</span> <span class="literal">True</span></span><br><span class="line">      <span class="attr">timeout_override:</span></span><br><span class="line">      <span class="attr">continue_if_exception:</span> <span class="literal">False</span></span><br><span class="line">      <span class="attr">disable_action:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">filtertype:</span> <span class="string">pattern</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">prefix</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">chuye-adcounter-</span></span><br><span class="line">      <span class="attr">exclude:</span> <span class="literal">True</span> <span class="comment">##默认为False，如果为True，表示排除。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">filtertype:</span> <span class="string">age</span></span><br><span class="line">      <span class="attr">source:</span> <span class="string">name</span></span><br><span class="line">      <span class="attr">direction:</span> <span class="string">older</span></span><br><span class="line">      <span class="attr">timestring:</span> <span class="string">&#x27;%Y.%m.%d&#x27;</span></span><br><span class="line">      <span class="attr">unit:</span> <span class="string">days</span></span><br><span class="line">      <span class="attr">unit_count:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">exclude:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">### 代码解释</span></span><br><span class="line">    <span class="string">第一步：指定要做的动作（delete_indices）删除索引。</span></span><br><span class="line">    <span class="string">第二步：使用filters过滤出要删除的参数。</span></span><br><span class="line">    <span class="string">第三步：使用filter：pathern模块，匹配要删除索引的名称，exclude=True表示排除。</span></span><br><span class="line">    <span class="string">第四步：</span> <span class="string">使用filter：age模块，匹配时间，删除多久。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="创建备份镜像"><a href="#创建备份镜像" class="headerlink" title="创建备份镜像"></a>创建备份镜像</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">actions:</span></span><br><span class="line">  <span class="attr">1:</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">snapshot</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&gt;-</span></span><br><span class="line"><span class="string">      Snapshot logstash- prefixed indices older than 1 day (based on index</span></span><br><span class="line"><span class="string">      creation_date) with the default snapshot name pattern of</span></span><br><span class="line"><span class="string">      &#x27;curator-%Y%m%d%H%M%S&#x27;.  Wait for the snapshot to complete.  Do not skip</span></span><br><span class="line"><span class="string">      the repository filesystem access check.  Use the other options to create</span></span><br><span class="line"><span class="string">      the snapshot.</span></span><br><span class="line"><span class="string"></span>    <span class="attr">options:</span></span><br><span class="line">      <span class="attr">repository:</span> <span class="string">search-backup</span> <span class="comment">##备份到那个仓库</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">search-%Y%m%d%H%M%S</span> <span class="comment">## 备份服务器的时间</span></span><br><span class="line">      <span class="attr">ignore_unavailable:</span> <span class="literal">False</span></span><br><span class="line">      <span class="attr">include_global_state:</span> <span class="literal">True</span></span><br><span class="line">      <span class="attr">partial:</span> <span class="literal">False</span></span><br><span class="line">      <span class="attr">wait_for_completion:</span> <span class="literal">True</span></span><br><span class="line">      <span class="attr">skip_repo_fs_check:</span> <span class="literal">False</span></span><br><span class="line">      <span class="attr">timeout_override:</span></span><br><span class="line">      <span class="attr">continue_if_exception:</span> <span class="literal">False</span></span><br><span class="line">      <span class="attr">disable_action:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">filtertype:</span> <span class="string">pattern</span>   <span class="comment">## 匹配要备份的分片</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">regex</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">.*</span></span><br><span class="line">      <span class="attr">exclude:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">filtertype:</span> <span class="string">age</span> <span class="comment">## 设置要备份的时间范围</span></span><br><span class="line">      <span class="attr">source:</span> <span class="string">creation_date</span></span><br><span class="line">      <span class="attr">direction:</span> <span class="string">older</span></span><br><span class="line">      <span class="attr">unit:</span> <span class="string">days</span></span><br><span class="line">      <span class="attr">unit_count:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">exclude:</span></span><br></pre></td></tr></table></figure>

<h2 id="帮助文档"><a href="#帮助文档" class="headerlink" title="帮助文档"></a>帮助文档</h2><p><a target="_blank" rel="noopener" href="http://elastic.co/guide/en/elasticsearch/client/curator/current">官方文档</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2016/12/01/elastic-study1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/12/01/elastic-study1/" class="post-title-link" itemprop="url">elasticsearch 生产环境配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-12-01 10:25:14" itemprop="dateCreated datePublished" datetime="2016-12-01T10:25:14+08:00">2016-12-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-09-16 17:29:58" itemprop="dateModified" datetime="2020-09-16T17:29:58+08:00">2020-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/elastic/" itemprop="url" rel="index"><span itemprop="name">elastic</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="elasticsearch-简介"><a href="#elasticsearch-简介" class="headerlink" title="elasticsearch 简介"></a>elasticsearch 简介</h2><p>ElasticSearch是一个基于Lucene构建的开源，分布式，RESTful搜索引擎;设计用于云计算；能够达到实时搜索，稳定，可靠，快速。</p>
<h3 id="ElasticSearch的一些概念"><a href="#ElasticSearch的一些概念" class="headerlink" title="ElasticSearch的一些概念:"></a>ElasticSearch的一些概念:</h3><h4 id="集群-cluster"><a href="#集群-cluster" class="headerlink" title="集群 (cluster)"></a>集群 (cluster)</h4><p>在一个分布式系统里面,可以通过多个elasticsearch运行实例组成一个集群,这个集群里面有一个节点叫做主节点(master),elasticsearch是去中心化的,所以这里的主节点是动态选举出来的,不存在单点故障。</p>
<p>在同一个子网内，只需要在每个节点上设置相同的集群名,elasticsearch就会自动的把这些集群名相同的节点组成一个集群。节点和节点之间通讯以及节点之间的数据分配和平衡全部由elasticsearch自动管理。<br>在外部看来elasticsearch就是一个整体。</p>
<h4 id="节点-node"><a href="#节点-node" class="headerlink" title="节点(node)"></a>节点(node)</h4><p>每一个运行实例称为一个节点,每一个运行实例既可以在同一机器上,也可以在不同的机器上.所谓运行实例,就是一个服务器进程.在测试环境内,可以在一台服务器上运行多个服务器进程,在生产环境建议每台服务器运行一个服务器进程。</p>
<h4 id="索引-index"><a href="#索引-index" class="headerlink" title="索引(index)"></a>索引(index)</h4><p>这里的索引是名词不是动词,在elasticsearch里面支持多个索引。类似于关系数据库里面每一个服务器可以支持多个数据库一样。在每一索引下面又支持多种类型，类似于关系数据库里面的一个数据库可以有多张表。但是本质上和关系数据库有很大的区别。这里暂时可以这么理解。</p>
<h4 id="分片-shards"><a href="#分片-shards" class="headerlink" title="分片(shards)"></a>分片(shards)</h4><p>把一个索引分解为多个小的索引，每一个小的索引叫做分片。分片后就可以把各个分片分配到不同的节点中。</p>
<h4 id="副本-replicas"><a href="#副本-replicas" class="headerlink" title="副本(replicas)"></a>副本(replicas)</h4><p>每一个分片可以有0到多个副本，每个副本都是分片的完整拷贝，可以用来增加速度，同时也可以提高系统的容错性，一旦某个节点数据损坏，其他节点可以代替他。</p>
<h2 id="实验环境介绍"><a href="#实验环境介绍" class="headerlink" title="实验环境介绍"></a>实验环境介绍</h2><p>实验环境规划</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>ip address</th>
<th>操作系统</th>
<th>职责</th>
</tr>
</thead>
<tbody><tr>
<td>linux-node1.example.com</td>
<td>192.168.56.11</td>
<td>centos7</td>
<td>elastic-master，nfs-server</td>
</tr>
<tr>
<td>linux-node2.example.com</td>
<td>192.168.56.12</td>
<td>centos7</td>
<td>elastic-slave</td>
</tr>
</tbody></table>
<p>系统版本环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 mount10:20:25]#uname -r</span><br><span class="line">3.10.0-229.el7.x86_64</span><br><span class="line">[root@linux-node1 mount12:07:36]#uname -m</span><br><span class="line">x86_64</span><br><span class="line">[root@linux-node1 mount12:07:41]#cat  /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.1.1503 (Core)</span><br></pre></td></tr></table></figure>



<h2 id="elastic安装过程"><a href="#elastic安装过程" class="headerlink" title="elastic安装过程"></a>elastic安装过程</h2><h3 id="安装elastic软件"><a href="#安装elastic软件" class="headerlink" title="安装elastic软件"></a>安装elastic软件</h3><h4 id="先安装java环境"><a href="#先安装java环境" class="headerlink" title="先安装java环境"></a>先安装java环境</h4><p><a href="https://www.biglittleant.cn/70.html">使用saltstack快速安装java环境
</a></p>
<h4 id="开始安装elastic"><a href="#开始安装elastic" class="headerlink" title="开始安装elastic"></a>开始安装elastic</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/</span><br><span class="line">curl -L -O https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.1.1/elasticsearch-2.1.1.tar.gz</span><br><span class="line">tar -zxf elasticsearch-2.1.1.tar.gz</span><br><span class="line">mv elasticsearch-2.1.1 /usr/local/</span><br><span class="line">cd ../</span><br><span class="line">ln -s elasticsearch-2.1.1/ elastic</span><br></pre></td></tr></table></figure>

<p><code>以上配置linux-node1,linux-node2 都执行一遍</code></p>
<h4 id="elasticsearch-yum-安装"><a href="#elasticsearch-yum-安装" class="headerlink" title="elasticsearch yum 安装"></a>elasticsearch yum 安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch</span><br><span class="line">cat &gt;/etc/yum.repos.d/elasticsearch.repo &lt;&lt;EOF</span><br><span class="line">[elasticsearch-2.x]</span><br><span class="line">name=Elasticsearch repository for 2.x packages</span><br><span class="line">baseurl=https://packages.elastic.co/elasticsearch/2.x/centos</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://packages.elastic.co/GPG-KEY-elasticsearch</span><br><span class="line">enabled=1</span><br><span class="line">EOF</span><br><span class="line">yum install elasticsearch</span><br></pre></td></tr></table></figure>

<h3 id="编辑elastic的配置文件"><a href="#编辑elastic的配置文件" class="headerlink" title="编辑elastic的配置文件"></a>编辑elastic的配置文件</h3><h4 id="完整的配置文件"><a href="#完整的配置文件" class="headerlink" title="完整的配置文件"></a>完整的配置文件</h4><p>elastic主节点配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">grep &#x27;^[a-z]&#x27; /usr/local/elastic/config/elasticsearch.yml</span><br><span class="line">cluster.name: biglittleant</span><br><span class="line">node.name: &quot;linux-node1&quot;</span><br><span class="line">index.number_of_shards: 5</span><br><span class="line">index.number_of_replicas: 1</span><br><span class="line">path.conf: /usr/local/elastic/config</span><br><span class="line">path.data: /usr/local/elastic/data</span><br><span class="line">path.work: /usr/local/elastic/work</span><br><span class="line">path.logs:  /usr/local/elastic/logs</span><br><span class="line">path.plugins: /usr/local/elastic/plugins</span><br><span class="line">bootstrap.mlockall: true</span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line">http.port: 9200</span><br><span class="line">network.host: 192.168.56.11</span><br><span class="line">discovery.zen.ping.multicast.enabled: false</span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;192.168.56.11&quot;, “192.168.56.12&quot;]</span><br><span class="line">path.repo: [&quot;/data/mount/&quot;]</span><br></pre></td></tr></table></figure>
<p>elastic从节点配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: biglittleant</span><br><span class="line">node.name: &quot;linux-node2&quot;</span><br><span class="line">discovery.zen.ping.multicast.enabled: false</span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;192.168.56.11&quot;, “192.168.56.12&quot;]</span><br><span class="line">path.repo: [&quot;/data/mount/&quot;]</span><br></pre></td></tr></table></figure>

<p>elastic单节点配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: biglittleant</span><br><span class="line">node.name: &quot;linux-node1&quot;</span><br><span class="line">index.number_of_shards: 1</span><br><span class="line">index.number_of_replicas: 0##单节点复制集要为0</span><br><span class="line">path.conf: /usr/local/elastic/config</span><br><span class="line">path.data: /usr/local/elastic/data</span><br><span class="line">path.work: /usr/local/elastic/work</span><br><span class="line">path.logs:  /usr/local/elastic/logs</span><br><span class="line">path.plugins: /usr/local/elastic/plugins</span><br><span class="line">bootstrap.mlockall: true</span><br><span class="line">http.port: 9200</span><br><span class="line">network.host: 192.168.56.11</span><br><span class="line">path.repo: [&quot;/data/mount/&quot;]</span><br></pre></td></tr></table></figure>


<h4 id="elasticsearch配置文件解释"><a href="#elasticsearch配置文件解释" class="headerlink" title="elasticsearch配置文件解释"></a>elasticsearch配置文件解释</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: biglittleant##集群节点的名称，一旦配置后不能更改。</span><br><span class="line">node.name: &quot;linux-node1&quot;#当前节点的名称</span><br><span class="line">index.number_of_shards: 5##索引分几个分片。</span><br><span class="line">index.number_of_replicas: 1##创建几个副本。</span><br><span class="line">path.conf: /usr/local/elastic/config##config 存放的位置</span><br><span class="line">path.data: /usr/local/elastic/data ##数据存放的位置</span><br><span class="line">#path.data: /path/to/data1,/path/to/data2 ###可以配置多个路径。</span><br><span class="line">path.work: /usr/local/elastic/work##临时文件存放路径</span><br><span class="line">path.logs:  /usr/local/elastic/logs##日志存放的路径</span><br><span class="line">path.plugins: /usr/local/elastic/plugins##插件存放的位置</span><br><span class="line">bootstrap.mlockall: true #锁住内存</span><br><span class="line">#transport.tcp.port: 9300 ###集群交互的端口。</span><br><span class="line">http.port: 9200 ##对外的端口</span><br><span class="line">network.host: 192.168.56.11#监听的网络，如果不配置默认为127.0.0.1</span><br><span class="line">discovery.zen.ping.multicast.enabled: false##禁用组播</span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;192.168.56.11&quot;, “192.168.56.12&quot;]#集群服务器的ip列表</span><br><span class="line">path.repo: [&quot;/data/mount/&quot;]#集群的备份仓库</span><br></pre></td></tr></table></figure>

<h3 id="安装elastic的服务器管理插件"><a href="#安装elastic的服务器管理插件" class="headerlink" title="安装elastic的服务器管理插件"></a>安装elastic的服务器管理插件</h3><h4 id="使用head插件来查看索引数据"><a href="#使用head插件来查看索引数据" class="headerlink" title="使用head插件来查看索引数据"></a>使用head插件来查看索引数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/elastic/bin/plugin install  mobz/elasticsearch-head</span><br><span class="line">http://192.168.56.11:9200/_plugin/head/</span><br></pre></td></tr></table></figure>
<h4 id="使用kopf来备份集群节点"><a href="#使用kopf来备份集群节点" class="headerlink" title="使用kopf来备份集群节点"></a>使用kopf来备份集群节点</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/elastic/bin/plugin install   lmenezes/elasticsearch-kopf</span><br><span class="line">http://192.168.56.11:9200/_plugin/kopf/</span><br></pre></td></tr></table></figure>

<h4 id="使用bigdesk查看集群性能"><a href="#使用bigdesk查看集群性能" class="headerlink" title="使用bigdesk查看集群性能"></a>使用bigdesk查看集群性能</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/elastic/bin/plugin install  hlstudio/bigdesk</span><br><span class="line">http://192.168.56.11:9200/_plugin/bigdesk/</span><br></pre></td></tr></table></figure>

<h4 id="安装中文分词插件"><a href="#安装中文分词插件" class="headerlink" title="安装中文分词插件"></a>安装中文分词插件</h4><p>第一步编译分词插件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum install maven</span><br><span class="line">git cloen https://github.com/medcl/elasticsearch-analysis-ik</span><br><span class="line">cd elasticsearch-analysis-ik</span><br><span class="line">mvn package</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编译完成：</span></span><br><span class="line">Downloaded: http://repo.maven.apache.org/maven2/org/codehaus/plexus/plexus-utils/2.0.1/plexus-utils-2.0.1.jar (217 KB at 43.5 KB/sec)</span><br><span class="line">[INFO] Reading assembly descriptor: /usr/local/src/elasticsearch-analysis-ik-1.10.0/src/main/assemblies/plugin.xml</span><br><span class="line">[INFO] Building zip: /usr/local/src/elasticsearch-analysis-ik-1.10.0/target/releases/elasticsearch-analysis-ik-1.10.0.zip</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time: 16:26.127s</span><br><span class="line">[INFO] Finished at: Mon Oct 10 16:58:59 CST 2016</span><br><span class="line">[INFO] Final Memory: 25M/61M</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 将编译好的IK分词拷贝到plugins目录中。</span></span></span><br><span class="line">cd target/releases/</span><br><span class="line">unzip elasticsearch-analysis-ik-1.10.0.zip -d ik</span><br><span class="line">mv elasticsearch-analysis-ik-1.10.0 /data/app/elastic/plugins/ik</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 修改ES的配置文件，打开config/elasticsearch.yml,在最后添加配置</span></span></span><br><span class="line"></span><br><span class="line">index.analysis.analyzer.default.type: ik</span><br></pre></td></tr></table></figure>

<p>第三步：重启elastic服务器，并查看日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart elasticsearch</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启elasticsearch即可,重启会看到以下plugins信息</span></span><br><span class="line">[2016-03-14 23:47:33,184][INFO ][plugins                  ] [Lightspeed] modules [lang-expression, lang-groovy], plugins [elasticsearch-analysis-ik], sites []</span><br></pre></td></tr></table></figure>

<p>安装<code>analysis-pinyin</code>的中文插件（可以不安装，步骤跟安装ik分词插件一样）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/medcl/elasticsearch-analysis-pinyin.git</span><br><span class="line">cd elasticsearch-analysis-pinyin</span><br><span class="line">mvn clean install -Dmaven.test.skip</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">复制target/releases目录下的*-pinyin.zip并解压到elasticsearch/plugins/</span></span><br><span class="line"></span><br><span class="line">index.analysis.analyzer.default.type: keyword</span><br></pre></td></tr></table></figure>



<h3 id="测试分词插件的效果"><a href="#测试分词插件的效果" class="headerlink" title="测试分词插件的效果"></a>测试分词插件的效果</h3><p><code>http://192.168.0.211:9200/_analyze?analyzer=ik&amp;pretty=true&amp;text=helloworld,欢迎你</code></p>
<blockquote>
<p>关于分词器的详细解释可以参考文章最后elastic分词器详细解释。</p>
</blockquote>
<h2 id="服务器启动前调优"><a href="#服务器启动前调优" class="headerlink" title="服务器启动前调优"></a>服务器启动前调优</h2><h3 id="常见优化参数"><a href="#常见优化参数" class="headerlink" title="常见优化参数"></a>常见优化参数</h3><p>提高索引性能和速度从几下方面着手：</p>
<ol>
<li>增大索引实时时间设置：<code>index.engine.robin.refresh_interval :10s</code> (默认为1s) 。</li>
<li>增大内存缓冲区： <code>indices.memory.index_buffer_size:20% </code>(默认为heap大小的10%)。</li>
<li>增加translog方面的设置：<code> index.translog.flush_threshold:10000</code> (默认为5000）。</li>
<li>增加分配给ES的内存， 默认为1g。</li>
<li>减小replaca. 索引时可设置为0. 完成索引后再设置成想要的。</li>
<li>增加机器数。</li>
<li><code>index.merge.policy.use_compound_file</code> 设置为false. 这样的话， 可以减少Merge （保证open file size 够 大）。</li>
</ol>
<h4 id="配置汇总"><a href="#配置汇总" class="headerlink" title="配置汇总"></a>配置汇总</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 第一部分</span></span></span><br><span class="line">index.analysis.analyzer.default.type: ik</span><br><span class="line">index.cache.field.type: soft</span><br><span class="line">index.cache.field.max_size: 50000</span><br><span class="line">index.cache.field.expire: 5m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 第二部分</span></span></span><br><span class="line">index.cache.query.enable: true</span><br><span class="line">indices.cache.query.size: 5%</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 第三部分</span></span></span><br><span class="line">index.search.slowlog.level: TRACE</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 第四部分</span></span></span><br><span class="line">index.store.compress.stored: true</span><br><span class="line">index.store.compress.tv: true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 第五部分</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">indices.store.throttle.type: none</span></span><br><span class="line">indices.store.throttle.max_bytes_per_sec: 100mb</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">index.routing.allocation.total_shards_per_node: 2</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">script.disable_dynamic: <span class="literal">false</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="配置解释"><a href="#配置解释" class="headerlink" title="配置解释"></a>配置解释</h4><h5 id="第一部分"><a href="#第一部分" class="headerlink" title="第一部分"></a>第一部分</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 设置es的缓存类型为Soft Reference，它的主要特点是据有较强的引用功能。只有当内存不够的时候，才进行回收这类内存，因此在内存足够的时候，它们通常不被回收。另外，这些引 用对象还能保证在Java抛出OutOfMemory 异常之前，被设置为null。它可以用于实现一些常用图片的缓存，实现Cache的功能，保证最大限度的使用内存而不引起OutOfMemory。在es的配置文件加上index.cache.field.type: soft即可。</span><br><span class="line">2. 上index.cache.field.type: soft ## 最大限度使用内存。</span><br><span class="line">3. index.cache.field.max_size: 50000## es最大缓存数据条数。</span><br><span class="line">4. index.cache.field.expire: 10m ##把过期时间设置成10分钟。</span><br></pre></td></tr></table></figure>


<h5 id="第二部分"><a href="#第二部分" class="headerlink" title="第二部分"></a>第二部分</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">index.cache.query.enable: true ##默认配置是false。</span><br><span class="line"></span><br><span class="line">indices.cache.query.size: 2%  ## 默认配置 1%。</span><br></pre></td></tr></table></figure>

<h5 id="第三部分"><a href="#第三部分" class="headerlink" title="第三部分"></a>第三部分</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.search.slowlog.level: TRACE</span><br></pre></td></tr></table></figure>

<p>慢查询的级别：TRACE，表示追踪模式。还可以设置成info模式。</p>
<h5 id="第四部分-索引相关"><a href="#第四部分-索引相关" class="headerlink" title="第四部分-索引相关"></a>第四部分-索引相关</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">index.store.compress.stored: true</span><br><span class="line"></span><br><span class="line">index.store.compress.tv: true</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在elasticsearch.yml设置这两个属性可压缩数据文件，极大的减少文件的大小。</p>
</blockquote>
<h5 id="第五部分-硬盘写入速率的设置"><a href="#第五部分-硬盘写入速率的设置" class="headerlink" title="第五部分-硬盘写入速率的设置"></a>第五部分-硬盘写入速率的设置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">indices.store.throttle.type: none</span></span><br><span class="line"></span><br><span class="line">indices.store.throttle.max_bytes_per_sec: 100mb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">index.routing.allocation.total_shards_per_node: 2</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">script.disable_dynamic: <span class="literal">false</span></span></span><br></pre></td></tr></table></figure>

<p>写入磁盘的速率，默认是20m&#x2F;s 适用于机械硬盘，100m&#x2F;s-200m&#x2F;s 适用于SSD硬盘。<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/guide/current/indexing-performance.html">参考文档</a></p>
<h3 id="配置NFS来存放elastic的备份"><a href="#配置NFS来存放elastic的备份" class="headerlink" title="配置NFS来存放elastic的备份"></a>配置NFS来存放elastic的备份</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">linux-node1上执行</span></span><br><span class="line">yum install nfs-utils rpcbind -y</span><br><span class="line">cat &gt;&gt; /etc/exports&lt;&lt;EOF</span><br><span class="line">/data/backup 192.168.56.0/24(rw,sync,all_squash)</span><br><span class="line">EOF</span><br><span class="line">mkdir /data/&#123;backup,mount&#125;  -p</span><br><span class="line">chown -R nfsnobody.nfsnobody /data/backup</span><br><span class="line">systemctl start rpcbind</span><br><span class="line">systemctl start nfs</span><br><span class="line">mount.nfs 192.168.56.11:/data/backup /data/mount/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">linux-node2上执行</span></span><br><span class="line">yum install nfs-utils rpcbind -y</span><br><span class="line">mkdir /data/mount -p</span><br><span class="line">mount.nfs 192.168.56.11:/data/backup /data/mount/</span><br></pre></td></tr></table></figure>

<h3 id="java参数的调优"><a href="#java参数的调优" class="headerlink" title="java参数的调优"></a>java参数的调优</h3><p>Heap不要超过系统可用内存的一半，并且不要超过32GB。JVM参数呢？对于初级用户来说，并不需要做特别调整，仍然遵从官方的建议，将xms和xmx设置成和heap一样大小，避免动态分配heap size就好了。虽然有针对性的调整JVM参数可以带来些许GC效率的提升，当有一些“坏”用例的时候，这些调整并不会有什么魔法效果帮你减轻heap压力，甚至可能让问题更糟糕。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/elastic/bin/elasticsearch.in.sh</span><br><span class="line">if [ &quot;x$ES_MIN_MEM&quot; = &quot;x&quot; ]; then</span><br><span class="line">    ES_MIN_MEM=256m</span><br><span class="line">fi</span><br><span class="line">if [ &quot;x$ES_MAX_MEM&quot; = &quot;x&quot; ]; then</span><br><span class="line">    ES_MAX_MEM=256m</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">虚拟机环境，所以配置了256M的内存，实际物理机器根据内存大小动态调节。</span></span><br></pre></td></tr></table></figure>

<h3 id="elastic-开启jmx-监控"><a href="#elastic-开启jmx-监控" class="headerlink" title="elastic 开启jmx 监控"></a>elastic 开启jmx 监控</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/elastic/bin/elasticsearch.in.sh</span><br><span class="line">JMX_PORT=9305</span><br><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS -Dcom.sun.management.jmxremote.port=$JMX_PORT&quot;</span><br><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS -Dcom.sun.management.jmxremote.ssl=false&quot;</span><br><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS -Djava.rmi.server.hostname=192.168.56.11&quot;</span><br></pre></td></tr></table></figure>

<h3 id="服务器优化"><a href="#服务器优化" class="headerlink" title="服务器优化"></a>服务器优化</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144##生产上一定要打开文件描述符。</span><br><span class="line">mkdir /usr/local/elastic/&#123;data,logs,work,plugins&#125; -p##创建相应的目录</span><br><span class="line">useradd elastic ##创建启动用户</span><br><span class="line">chown -R elastic.elastic /usr/local/elasticsearch-2.1.1/</span><br></pre></td></tr></table></figure>

<h2 id="启动elastic服务"><a href="#启动elastic服务" class="headerlink" title="启动elastic服务"></a>启动elastic服务</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">su -c &#x27;/usr/local/elastic/bin/elasticsearch -d &#x27; elastic</span><br><span class="line">##启动服务</span><br><span class="line">##查看端口是否存在</span><br><span class="line">ss -lntup |grep 9300</span><br><span class="line">tcp    LISTEN     0      50                    :::9300                 :::*      users:((&quot;java&quot;,9757,56))</span><br><span class="line"># ss -lntup |grep 9200</span><br><span class="line">tcp    LISTEN     0      50                    :::9200                 :::*      users:((&quot;java&quot;,9757,94))</span><br><span class="line"></span><br><span class="line">##curl 查看结果 ：</span><br><span class="line">curl http://192.168.56.11:9200</span><br><span class="line">&#123;</span><br><span class="line">  &quot;status&quot; : 200,</span><br><span class="line">  &quot;name&quot; : &quot;linux-node1&quot;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;biglittleant&quot;,</span><br><span class="line">  &quot;version&quot; : &#123;</span><br><span class="line">    &quot;number&quot; : &quot;1.7.1&quot;,</span><br><span class="line">    &quot;build_hash&quot; : &quot;b88f43fc40b0bcd7f173a1f9ee2e97816de80b19&quot;,</span><br><span class="line">    &quot;build_timestamp&quot; : &quot;2015-07-29T09:54:16Z&quot;,</span><br><span class="line">    &quot;build_snapshot&quot; : false,</span><br><span class="line">    &quot;lucene_version&quot; : &quot;4.10.4&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="管理集群配置"><a href="#管理集群配置" class="headerlink" title="管理集群配置"></a>管理集群配置</h2><h3 id="查看集群设置"><a href="#查看集群设置" class="headerlink" title="查看集群设置"></a>查看集群设置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http://10.10.160.129:9200/_cluster/settings</span><br></pre></td></tr></table></figure>
<h3 id="停止分片同步"><a href="#停止分片同步" class="headerlink" title="停止分片同步"></a>停止分片同步</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT http://10.10.160.129:9200/_cluster/settings -d &#x27;&#123;</span><br><span class="line">  &quot;transient&quot; : &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.enable&quot; : &quot;none&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="启动分片同步"><a href="#启动分片同步" class="headerlink" title="启动分片同步"></a>启动分片同步</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT http://10.10.160.129:9200/_cluster/settings -d &#x27;&#123;</span><br><span class="line">  &quot;transient&quot; : &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.enable&quot; : &quot;all&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="备份elasticsearch-数据"><a href="#备份elasticsearch-数据" class="headerlink" title="备份elasticsearch 数据"></a>备份elasticsearch 数据</h2><p>先导入一些数据进行备份</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST &#x27;http://192.168.56.11:9200/bank/account/_bulk?pretty&#x27; --data-binary @accounts.json</span><br><span class="line">curl -XPOST &#x27;http://192.168.56.11:9200/shakespeare/_bulk?pretty&#x27; --data-binary @shakespeare.json</span><br><span class="line">curl -XPOST &#x27;http://192.168.56.11:9200/_bulk?pretty&#x27; --data-binary @logs.jsonl</span><br></pre></td></tr></table></figure>

<h3 id="使用API创建一个镜像仓库"><a href="#使用API创建一个镜像仓库" class="headerlink" title="使用API创建一个镜像仓库"></a>使用API创建一个镜像仓库</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http://192.168.56.11:9200/_snapshot/my_backup -d &#x27;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;type&quot;: &quot;fs&quot;,</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;location&quot;: &quot;/data/mount&quot;</span><br><span class="line">        &quot;compress&quot;:  true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;</span><br><span class="line">##解释：</span><br><span class="line">镜像仓库的名称：my_backup</span><br><span class="line">镜像仓库的类型：fs。还支持curl，hdfs等。</span><br><span class="line">镜像仓库的位置：/data/mount 。这个位置必须在配置文件中定义。</span><br><span class="line">是否启用压缩：compres：true 表示启用压缩。</span><br></pre></td></tr></table></figure>

<h3 id="备份前检查配置"><a href="#备份前检查配置" class="headerlink" title="备份前检查配置"></a>备份前检查配置</h3><p>必须确定备份使用的目录在配置文件中声明了，否则会爆如下错误</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;error&quot;: &#123;</span><br><span class="line">    &quot;root_cause&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot;: &quot;repository_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;[test-bakcup] failed to create repository&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;type&quot;: &quot;repository_exception&quot;,</span><br><span class="line">    &quot;reason&quot;: &quot;[test-bakcup] failed to create repository&quot;,</span><br><span class="line">    &quot;caused_by&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;creation_exception&quot;,</span><br><span class="line">      &quot;reason&quot;: &quot;Guice creation errors:\n\n1) Error injecting constructor, RepositoryException[[test-bakcup] location [/data/mount] doesn&#x27;t match any of the locations specified by path.repo because this setting is empty]\n  at org.elasticsearch.repositories.fs.FsRepository.&lt;init&gt;(Unknown Source)\n  while locating org.elasticsearch.repositories.fs.FsRepository\n  while locating org.elasticsearch.repositories.Repository\n\n1 error&quot;,</span><br><span class="line">      &quot;caused_by&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;repository_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;[test-bakcup] location [/data/mount] doesn&#x27;t match any of the locations specified by path.repo because this setting is empty&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: 500</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="开始创建一个快照"><a href="#开始创建一个快照" class="headerlink" title="开始创建一个快照"></a>开始创建一个快照</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#在后头创建一个快照</span></span></span><br><span class="line">curl -XPUT  http://192.168.56.20:9200/_snapshot/my_backup/snapshot_1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#也可以在前台运行。</span></span></span><br><span class="line">curl -XPUT  http://192.168.56.11:9200/_snapshot/my_backup/snapshot_1?wait_for_completion=true</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#上面的参数会在my_backup仓库里创建一个snapshot_1 的快照。</span></span></span><br></pre></td></tr></table></figure>
<h3 id="可以选择相应的索引进行备份"><a href="#可以选择相应的索引进行备份" class="headerlink" title="可以选择相应的索引进行备份"></a>可以选择相应的索引进行备份</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT  http://192.168.56.20:9200/_snapshot/my_backup/snapshot_2 -d &#x27;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;indices&quot;: &quot;bank,logstash-2015.05.18&quot;</span><br><span class="line">&#125;&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#解释：</span></span></span><br><span class="line">创建一个snapshot_2的快照，只备份bank,logstash-2015.05.18这两个索引。</span><br></pre></td></tr></table></figure>

<h3 id="查看备份状态"><a href="#查看备份状态" class="headerlink" title="查看备份状态"></a>查看备份状态</h3><p>整个备份过程中，可以通过如下命令查看备份进度</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http://192.168.0.1:9200/_snapshot/my_backup/snapshot_20150812/_status</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>主要由如下几种状态：</p>
<ul>
<li>INITIALIZING 集群状态检查，检查当前集群是否可以做快照，通常这个过程会非常快</li>
<li>STARTED 正在转移数据到仓库</li>
<li>FINALIZING 数据转移完成，正在转移元信息</li>
<li>DONE　完成</li>
<li>FAILED 备份失败</li>
</ul>
<h3 id="取消备份"><a href="#取消备份" class="headerlink" title="取消备份"></a>取消备份</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE http://192.168.0.1:9200/_snapshot/my_backup/snapshot_20150812</span><br></pre></td></tr></table></figure>
<h3 id="获取所有快照信息。"><a href="#获取所有快照信息。" class="headerlink" title="获取所有快照信息。"></a>获取所有快照信息。</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http://192.168.56.20:9200/_snapshot/my_backup/_all |python -mjson.tool</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#解释</span></span></span><br><span class="line">查看my_backup仓库下的所有快照。</span><br></pre></td></tr></table></figure>
<h3 id="手动删除快照"><a href="#手动删除快照" class="headerlink" title="手动删除快照"></a>手动删除快照</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE http://192.168.56.20:9200/_snapshot/my_backup/snapshot_2</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#解释</span></span></span><br><span class="line">删除my_backup仓库下的snapshot_2的快照。</span><br></pre></td></tr></table></figure>
<h2 id="备份恢复"><a href="#备份恢复" class="headerlink" title="备份恢复"></a>备份恢复</h2><h3 id="恢复备份"><a href="#恢复备份" class="headerlink" title="恢复备份"></a>恢复备份</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http://192.168.0.1:9200/_snapshot/my_backup/snapshot_20150812/_restore</span><br></pre></td></tr></table></figure>
<p>同备份一样，也可以设置wait_for_completion&#x3D;true等待恢复结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http://192.168.0.1:9200/_snapshot/my_backup/snapshot_20150812/_restore?wait_for_completion=true</span><br></pre></td></tr></table></figure>
<p>默认情况下，是恢复所有的索引，我们也可以设置一些参数来指定恢复的索引，以及重命令恢复的索引，这样可以避免覆盖原有的数据.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http://192.168.0.1:9200/_snapshot/my_backup/snapshot_20150812/_restore</span><br><span class="line">&#123;</span><br><span class="line">    &quot;indices&quot;: &quot;index_1&quot;,</span><br><span class="line">    &quot;rename_pattern&quot;: &quot;index_(.+)&quot;,</span><br><span class="line">    &quot;rename_replacement&quot;: &quot;restored_index_$1&quot;</span><br><span class="line">&#125;</span><br><span class="line">上面的indices, 表示只恢复索引’index_1’</span><br><span class="line">rename_pattern: 表示重命名索引以’index_’开头的索引.</span><br><span class="line">rename_replacement: 表示将所有的索引重命名为’restored_index_xxx’.如index_1会被重命名为restored_index_1.</span><br></pre></td></tr></table></figure>


<h3 id="查看所有索引的恢复进度"><a href="#查看所有索引的恢复进度" class="headerlink" title="查看所有索引的恢复进度"></a>查看所有索引的恢复进度</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http://192.168.0.1:9200/_recovery/</span><br></pre></td></tr></table></figure>

<h3 id="查看索引restored-index-1的恢复进度"><a href="#查看索引restored-index-1的恢复进度" class="headerlink" title="查看索引restored_index_1的恢复进度"></a>查看索引restored_index_1的恢复进度</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http://192.168.0.1:9200/_recovery/restored_index_1</span><br></pre></td></tr></table></figure>
<h3 id="取消恢复"><a href="#取消恢复" class="headerlink" title="取消恢复"></a>取消恢复</h3><p>只需要删除索引，即可取消恢复</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE http://192.168.0.1:9200/restored_index_1</span><br></pre></td></tr></table></figure>


<h2 id="动态缩写或者扩容副本分片数量"><a href="#动态缩写或者扩容副本分片数量" class="headerlink" title="动态缩写或者扩容副本分片数量"></a>动态缩写或者扩容副本分片数量</h2><p>副本节点的数量可以在运行中的集群中动态的变更，这允许我们可以根据需求扩大或者缩小规模。</p>
<p>比如我们执行一次缩小规模操作:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT  http://192.168.56.12:9200/shakespeare/_settings &#x27;</span><br><span class="line">&#123;</span><br><span class="line">   &quot;number_of_replicas&quot; : 3</span><br><span class="line">&#125;&#x27;</span><br><span class="line">执行结果返回:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;acknowledged&quot;: true</span><br></pre></td></tr></table></figure>

<p>这时,我们看到片的信息分又重新做了调整: 主分片分布在节点es-node1,es-node3,es-node4上.从分片分布在es-node2,es-node3,es-node4上.</p>
<h2 id="运维相关"><a href="#运维相关" class="headerlink" title="运维相关"></a>运维相关</h2><h3 id="如何重启elastic单台节点"><a href="#如何重启elastic单台节点" class="headerlink" title="如何重启elastic单台节点"></a>如何重启elastic单台节点</h3><ul>
<li>停止数据写入，在重启单台节点，启动后分配同步会很快。</li>
<li>如果开启数据写入，在重启单台节点，分片同步会很耗时。</li>
</ul>
<h2 id="elastic-帮助文档"><a href="#elastic-帮助文档" class="headerlink" title="elastic 帮助文档"></a>elastic 帮助文档</h2><p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/guguli/p/5218297.html">elastic调优参考</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Wprosdocimo/Elasticsearch-zabbix">elastic监控</a></p>
<p><a target="_blank" rel="noopener" href="http://udn.yyuap.com/doc/mastering-elasticsearch/chapter-4/41_README.html">Mastering Elasticsearch(中文版)</a></p>
<p><a target="_blank" rel="noopener" href="http://kibana.logstash.es/content/logstash/plugins/input/file.html">ELK-权威指南</a></p>
<p><a target="_blank" rel="noopener" href="http://www.learnes.net/index.html">Elasticsearch 权威指南</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/zhang-shijie/p/5377127.html">ELK 之二：ElasticSearch 和Logstash高级使用</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch-migration/tree/1.x">升级版本-检查插件</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/buzzlight/p/elasticsearch_analysis.html">elastic-分词器详细解释</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/mallocator/Elasticsearch-Exporter">elasticsearch-数据导出工具</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-migration">elasticsearch-数据在线导出</a></p>
<h2 id="elastic-生产部署时遇到的问题"><a href="#elastic-生产部署时遇到的问题" class="headerlink" title="elastic-生产部署时遇到的问题"></a>elastic-生产部署时遇到的问题</h2><h3 id="out-of-memory错误"><a href="#out-of-memory错误" class="headerlink" title="out of memory错误"></a>out of memory错误</h3><p>因为默认情况下es对字段数据缓存（Field Data Cache）大小是无限制的，查询时会把字段值放到内存，特别是facet查询，对内存要求非常高，它会把结果都放在内存，然后进行排序等操作，一直使用内存，直到内存用完，当内存不够用时就有可能出现out of memory错误。</p>
<h4 id="问题原理"><a href="#问题原理" class="headerlink" title="问题原理"></a>问题原理</h4><ol>
<li><p>设置es的缓存类型为Soft Reference，它的主要特点是据有较强的引用功能。只有当内存不够的时候，才进行回收这类内存，因此在内存足够的时候，它们通常不被回收。另外，这些引 用对象还能保证在Java抛出OutOfMemory 异常之前，被设置为null。它可以用于实现一些常用图片的缓存，实现Cache的功能，保证最大限度的使用内存而不引起OutOfMemory。在es的配置文件加上index.cache.field.type: soft即可。</p>
</li>
<li><p>设置es最大缓存数据条数和缓存失效时间，通过设置index.cache.field.max_size: 50000来把缓存field的最大值设置为50000，设置index.cache.field.expire: 10m把过期时间设置成10分钟。</p>
</li>
</ol>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">index.cache.field.type: soft</span><br><span class="line">index.cache.field.max_size: 50000</span><br><span class="line">index.cache.field.expire: 5m</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2016/10/10/pip-%E4%BF%AE%E6%94%B9%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E6%BA%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/10/10/pip-%E4%BF%AE%E6%94%B9%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E6%BA%90/" class="post-title-link" itemprop="url">pip-修改国内镜像源</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-10-10 14:44:31" itemprop="dateCreated datePublished" datetime="2016-10-10T14:44:31+08:00">2016-10-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-09-18 18:24:53" itemprop="dateModified" datetime="2020-09-18T18:24:53+08:00">2020-09-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/.pip</span><br><span class="line">vim ~/.pip/pip.conf</span><br><span class="line">[global]</span><br><span class="line">index-url = http://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">[install]</span><br><span class="line">trusted-host = mirrors.aliyun.com</span><br></pre></td></tr></table></figure>

<p>注意事项：</p>
<ol>
<li><p><a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/pypi/simple/">http://mirrors.aliyun.com/pypi/simple/</a> 中的simple目录必须有。</p>
</li>
<li><p>–no-cache-dir 重新下载安装包，而不是使用缓存包。</p>
</li>
<li><p>trusted-host &#x3D; mirrors.aliyun.com 一定要加上这行，否则会报错。</p>
</li>
<li><p>pip国内镜像源</p>
<p> 阿里云 <a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/pypi/simple/">http://mirrors.aliyun.com/pypi/simple/</a><br> 中国科技大学 <a target="_blank" rel="noopener" href="https://pypi.mirrors.ustc.edu.cn/simple/">https://pypi.mirrors.ustc.edu.cn/simple/</a><br> 豆瓣 <a target="_blank" rel="noopener" href="http://pypi.douban.com/simple">http://pypi.douban.com/simple</a><br> Python官方 <a target="_blank" rel="noopener" href="https://pypi.python.org/simple/">https://pypi.python.org/simple/</a><br> v2ex <a target="_blank" rel="noopener" href="http://pypi.v2ex.com/simple/">http://pypi.v2ex.com/simple/</a><br> 中国科学院 <a target="_blank" rel="noopener" href="http://pypi.mirrors.opencas.cn/simple/">http://pypi.mirrors.opencas.cn/simple/</a><br> 清华大学 <a target="_blank" rel="noopener" href="https://pypi.tuna.tsinghua.edu.cn/simple/">https://pypi.tuna.tsinghua.edu.cn/simple/</a></p>
</li>
</ol>
<h2 id="报错汇总"><a href="#报错汇总" class="headerlink" title="报错汇总"></a>报错汇总</h2><h3 id="报错内容"><a href="#报错内容" class="headerlink" title="报错内容"></a>报错内容</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pip install mysql-python</span><br><span class="line">Collecting mysql-python</span><br><span class="line">  The repository located at pypi.douban.com is not a trusted or secure host and is being ignored. If this repository is available via HTTPS it is recommended to use HTTPS instead, otherwise you may silence this warning and allow it anyways with &#x27;--trusted-host pypi.douban.com&#x27;.</span><br><span class="line">  Could not find a version that satisfies the requirement mysql-python (from versions: )</span><br><span class="line">No matching distribution found for mysql-python</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>编辑 vim .pip&#x2F;pip.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[install]</span><br><span class="line">trusted-host = mirrors.aliyun.com</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Big Little Ant</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
