<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.biglittleant.cn","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"right","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Big Little Ant">
<meta property="og:url" content="http://www.biglittleant.cn/page/2/index.html">
<meta property="og:site_name" content="Big Little Ant">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Big Little Ant">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://www.biglittleant.cn/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Big Little Ant</title>
  






  <script async defer data-website-id="" src=""></script>

  <script defer data-domain="" src=""></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Big Little Ant</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">不被嘲笑的梦想，是不值得去实现的</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-文章分类"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>文章分类</a></li><li class="menu-item menu-item-golang"><a href="/categories/go" rel="section"><i class="fa fa-th fa-fw"></i>Golang</a></li><li class="menu-item menu-item-kubernetes"><a href="/categories/kubernetes" rel="section"><i class="fa fa-th fa-fw"></i>Kubernetes</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-关于"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Big Little Ant</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2018/09/20/ansible-when/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/09/20/ansible-when/" class="post-title-link" itemprop="url">死磕ansible系列--when函数的作用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-09-20 20:18:33" itemprop="dateCreated datePublished" datetime="2018-09-20T20:18:33+08:00">2018-09-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-10-10 11:24:36" itemprop="dateModified" datetime="2020-10-10T11:24:36+08:00">2020-10-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/ansible/" itemprop="url" rel="index"><span itemprop="name">ansible</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="when"><a href="#when" class="headerlink" title="when"></a>when</h2><p>可以使用when做条件判断</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;shut down Debian flavored systems&quot;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">/sbin/shutdown</span> <span class="string">-t</span> <span class="string">now</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_facts[&#x27;os_family&#x27;]</span> <span class="string">==</span> <span class="string">&quot;Debian&quot;</span></span><br></pre></td></tr></table></figure>

<p>同时我们可以使用 or 来指定多个条件语句</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;shut down CentOS 6 and Debian 7 systems&quot;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">/sbin/shutdown</span> <span class="string">-t</span> <span class="string">now</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">(ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span> <span class="string">and</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;6&quot;</span><span class="string">)</span> <span class="string">or</span></span><br><span class="line">          <span class="string">(ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;Debian&quot;</span> <span class="string">and</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;7&quot;</span><span class="string">)</span></span><br><span class="line"><span class="string">````</span></span><br><span class="line"></span><br><span class="line"><span class="string">我们可以写多行来实现and的情况</span></span><br><span class="line"></span><br><span class="line"><span class="string">```yaml</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;shut down CentOS 6 systems&quot;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">/sbin/shutdown</span> <span class="string">-t</span> <span class="string">now</span></span><br><span class="line">    <span class="attr">when:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;6&quot;</span></span><br></pre></td></tr></table></figure>

<p>假设我们要忽略一个语句的错误，然后根据成功或失败决定有条件地执行某项操作</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span> <span class="string">/bin/false</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">    <span class="attr">ignore_errors:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span> <span class="string">/bin/something</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">result</span> <span class="string">is</span> <span class="string">failed</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># In older versions of ansible use ``success``, now both are valid but succeeded uses the correct tense.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span> <span class="string">/bin/something_else</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">result</span> <span class="string">is</span> <span class="string">succeeded</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span> <span class="string">/bin/still/something_else</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">result</span> <span class="string">is</span> <span class="string">skipped</span></span><br></pre></td></tr></table></figure>

<p>var 可以使用 ‘yes’, ‘on’, ‘1’, ‘true’ 这些值设置bool值，然后进行规制判断。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vars:</span></span><br><span class="line">  <span class="attr">epic:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">monumental:</span> <span class="string">&quot;yes&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;This certainly is epic!&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">epic</span> <span class="string">or</span> <span class="string">monumental|bool</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;This certainly isn&#x27;t epic!&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">not</span> <span class="string">epic</span></span><br></pre></td></tr></table></figure>

<p>可以判断当前变量是否定义来执行相应的条件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;I&#x27;ve got &#x27;<span class="template-variable">&#123;&#123; foo &#125;&#125;</span>&#x27; and am not afraid to use it!&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">foo</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">fail:</span> <span class="string">msg=&quot;Bailing</span> <span class="string">out.</span> <span class="string">this</span> <span class="string">play</span> <span class="string">requires</span> <span class="string">&#x27;bar&#x27;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">      when: bar is undefined</span></span><br></pre></td></tr></table></figure>

<p>when函数可以结合loop函数一起使用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">command:</span> <span class="string">echo</span> &#123;&#123; <span class="string">item</span> &#125;&#125;</span><br><span class="line">      <span class="attr">loop:</span> [ <span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span> ]</span><br><span class="line">      <span class="attr">when:</span> <span class="string">item</span> <span class="string">&gt;</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">command:</span> <span class="string">echo</span> &#123;&#123; <span class="string">item</span> &#125;&#125;</span><br><span class="line">  <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; mylist|default([]) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">item</span> <span class="string">&gt;</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>loop 可以是个字典</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">command:</span> <span class="string">echo</span> &#123;&#123; <span class="string">item.key</span> &#125;&#125;</span><br><span class="line">  <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; query(&#x27;dict&#x27;, mydict|default(&#123;&#125;)) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">item.value</span> <span class="string">&gt;</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>when 条件还可以在 role incloud import 下使用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">import_tasks:</span> <span class="string">tasks/sometasks.yml</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">&quot;&#x27;reticulating splines&#x27; in output&quot;</span></span><br></pre></td></tr></table></figure>


<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">debian_stock_config</span></span><br><span class="line">       <span class="attr">when:</span> <span class="string">ansible_facts[&#x27;os_family&#x27;]</span> <span class="string">==</span> <span class="string">&#x27;Debian&#x27;</span></span><br></pre></td></tr></table></figure>

<p>当我们使用incloud_*的时候，它仅适用于包含任务本身，而不适用于包含文件中的任何其他任务。例子如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># We wish to include a file to define a variable when it is not</span></span><br><span class="line"><span class="comment"># already defined</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># main.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">import_tasks:</span> <span class="string">other_tasks.yml</span> <span class="comment"># note &quot;import&quot;</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">x</span> <span class="string">is</span> <span class="string">not</span> <span class="string">defined</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># other_tasks.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">    <span class="attr">x:</span> <span class="string">foo</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">var:</span> <span class="string">x</span></span><br></pre></td></tr></table></figure>

<p>上面的配置，等同于</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">    <span class="attr">x:</span> <span class="string">foo</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">x</span> <span class="string">is</span> <span class="string">not</span> <span class="string">defined</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">var:</span> <span class="string">x</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">x</span> <span class="string">is</span> <span class="string">not</span> <span class="string">defined</span></span><br></pre></td></tr></table></figure>

<p>因此，如果最初未定义x，则将跳过调试任务。通过使用include_tasks而不是import_tasks，other_tasks.yml中的两个任务都将按预期执行。</p>
<p>有些时候我们希望一个playbook可以应用多个操作系统。我们可以这是配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;vars/common.yml&quot;</span></span><br><span class="line">    <span class="bullet">-</span> [ <span class="string">&quot;vars/<span class="template-variable">&#123;&#123; ansible_facts[&#x27;os_family&#x27;] &#125;&#125;</span>.yml&quot;</span>, <span class="string">&quot;vars/os_defaults.yml&quot;</span> ]</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">make</span> <span class="string">sure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">name=&#123;&#123;</span> <span class="string">apache</span> <span class="string">&#125;&#125;</span> <span class="string">state=started</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># for vars/RedHat.yml</span></span><br><span class="line"><span class="attr">apache:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">somethingelse:</span> <span class="number">42</span></span><br></pre></td></tr></table></figure>


<p>Register Variables 可以和when一起使用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">play</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">cat</span> <span class="string">/etc/motd</span></span><br><span class="line">        <span class="attr">register:</span> <span class="string">motd_contents</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;motd contains the word hi&quot;</span></span><br><span class="line">        <span class="attr">when:</span> <span class="string">motd_contents.stdout.find(&#x27;hi&#x27;)</span> <span class="type">!=</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- hosts: webservers</span><br><span class="line">  roles:</span><br><span class="line">     - &#123; role: debian_stock_config, when: ansible_os_family == &#x27;Debian&#x27; &#125;</span><br></pre></td></tr></table></figure>


<p>register 中有个stdout_lines的变量，可以帮你将结果按照split做切割。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">registered</span> <span class="string">variable</span> <span class="string">usage</span> <span class="string">as</span> <span class="string">a</span> <span class="string">loop</span> <span class="string">list</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">retrieve</span> <span class="string">the</span> <span class="string">list</span> <span class="string">of</span> <span class="string">home</span> <span class="string">directories</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">ls</span> <span class="string">/home</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">home_dirs</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">home</span> <span class="string">dirs</span> <span class="string">to</span> <span class="string">the</span> <span class="string">backup</span> <span class="string">spooler</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/mnt/bkspool/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">/home/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">link</span></span><br><span class="line">      <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; home_dirs.stdout_lines &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="comment"># same as loop: &quot;&#123;&#123; home_dirs.stdout.split() &#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>也可以判断 stdout 是否为空</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">registered</span> <span class="string">variable</span> <span class="string">for</span> <span class="string">emptiness</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">list</span> <span class="string">contents</span> <span class="string">of</span> <span class="string">directory</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">ls</span> <span class="string">mydir</span></span><br><span class="line">        <span class="attr">register:</span> <span class="string">contents</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">contents</span> <span class="string">for</span> <span class="string">emptiness</span></span><br><span class="line">        <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">&quot;Directory is empty&quot;</span></span><br><span class="line">        <span class="attr">when:</span> <span class="string">contents.stdout</span> <span class="string">==</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- name: test play</span><br><span class="line">  hosts: mfs</span><br><span class="line">  tasks:</span><br><span class="line">      - shell: cat /etc/motd</span><br><span class="line">        register: motd_contents</span><br><span class="line"></span><br><span class="line">      - shell: echo &quot;motd contains the word hi&quot; &gt; /tmp/test2</span><br><span class="line">        when: motd_contents.stdout.find(&#x27;hi&#x27;) != -1</span><br></pre></td></tr></table></figure>

<h3 id="changed-when"><a href="#changed-when" class="headerlink" title="changed_when"></a>changed_when</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">  - shell: /usr/bin/billybass --mode=&quot;take me to the river&quot;</span><br><span class="line">    register: bass_result</span><br><span class="line">    changed_when: &quot;bass_result.rc != 2&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">this will never report <span class="string">&#x27;changed&#x27;</span> status</span></span><br><span class="line">  - shell: wall &#x27;beep&#x27;</span><br><span class="line">    changed_when: False</span><br></pre></td></tr></table></figure>

<h3 id="failed-when"><a href="#failed-when" class="headerlink" title="failed_when"></a>failed_when</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: this command prints FAILED when it fails</span><br><span class="line">  command: /usr/bin/example-command -x -y -z</span><br><span class="line">  register: command_result</span><br><span class="line">  failed_when: &quot;&#x27;FAILED&#x27; in command_result.stderr&quot;</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  - name: this command prints FAILED when it fails</span><br><span class="line">  command: /usr/bin/example-command -x -y -z</span><br><span class="line">  register: command_result</span><br><span class="line">  ignore_errors: True</span><br><span class="line"></span><br><span class="line">- name: fail the play if the previous command did not succeed</span><br><span class="line">  fail: msg=&quot;the command failed&quot;</span><br><span class="line">  when: &quot;&#x27;FAILED&#x27; in command_result.stderr&quot;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2018/09/16/ansible-ad-hoc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/09/16/ansible-ad-hoc/" class="post-title-link" itemprop="url">死磕ansible系列--Ad-hoc模块</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-09-16 20:18:33" itemprop="dateCreated datePublished" datetime="2018-09-16T20:18:33+08:00">2018-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-10-10 11:24:09" itemprop="dateModified" datetime="2020-10-10T11:24:09+08:00">2020-10-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/ansible/" itemprop="url" rel="index"><span itemprop="name">ansible</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Ad-hoc"><a href="#Ad-hoc" class="headerlink" title="Ad-hoc"></a>Ad-hoc</h2><p>Ad-Hoc 是指ansible下临时执行的一条命令，并且不需要保存的命令，对于复杂的命令会使用playbook。Ad-hoc的执行依赖于模块，ansible官方提供了大量的模块。 如：command、raw、shell、file、cron等，具体可以通过ansible-doc -l 进行查看 。可以使用ansible-doc -s module来查看某个模块的参数，也可以使用ansible-doc help module来查看该模块更详细的信息。</p>
<h2 id="ansible-命令帮助"><a href="#ansible-命令帮助" class="headerlink" title="ansible 命令帮助"></a>ansible 命令帮助</h2><p>一个ad-hoc命令的执行，需要按以下格式进行执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 主机或组-m 模块名-a &#x27;模块参数&#x27;  ansible参数</span><br></pre></td></tr></table></figure>

<ul>
<li>主机和组，是在&#x2F;etc&#x2F;ansible&#x2F;hosts 里进行指定的部分，当然动态Inventory 使用的是脚本从外部应用里获取的主机。</li>
<li>模块名，可以通过<code>ansible-doc -l</code> 查看目前安装的模块，默认不指定时，使用的是command模块，具体可以查看<code>/etc/ansible/ansible.cfg</code> 的<code>#module_name = command</code> 部分，默认模块可以在该配置文件中进行修改。</li>
<li>模块参数，可以通过 <code>ansible-doc -s 模块名</code> 查看具体的用法及后面的参数。</li>
<li>ansible参数，可以通过ansible命令的帮助信息里查看到，这里有很多参数可以供选择，如是否需要输入密码、是否sudo等。</li>
</ul>
<h3 id="常用选项"><a href="#常用选项" class="headerlink" title="常用选项"></a>常用选项</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ansible &lt;host-pattern&gt; [options]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-i</code>：指定hosts</li>
<li><code>-m</code>： 指定执行的模块。</li>
<li><code>-a</code>: 指定相关的参数。</li>
<li><code>-v，--verbose</code>: 输出更详细的执行过程信息</li>
<li><code>-i PATH，--inventory=PATH</code>: 指定inventory信息</li>
<li><code>-f NUM,--fork NUM</code>：指定线程数。</li>
<li><code>--private-key=PRIVATE_KEY_FILE</code>: 指定秘钥文件。</li>
<li><code>-M DIRECTORY,--module-path=DIRECTORY</code>: 指定模块存放路径。</li>
<li><code>-a ’ARGUMECTORY’,--args=’ARGUMENTS’</code>:模块参数。</li>
<li><code>-k,--ask-pass SSH</code>:认证密码（通常在node机器上没有做过免秘钥的时候用）。</li>
<li><code>-K,--ask-sudo-pass sudo</code>:用户密码（–sudo时用）。</li>
<li><code>-t DIRECTORY,--tree=DIRECTORY</code>：输出信息至DIRECTORY目录下，结果文件以远程主机名命名。</li>
<li><code>-t SECONDS,--timeout=SECONDS</code>: 指定远程主机最大超时，单位是秒。</li>
<li><code>-u USERNAME,--username</code>: 指定远程主机以username运行命令。</li>
<li><code>-l SUBSET,--limit=SUBSET</code>: 指定运行主机。</li>
<li><code>-l ~REGEX</code>: 指定运行主机（正则）。</li>
<li><code>--list-hosts</code>: 列出符合条件的主机列表，不执行任何命令。</li>
</ul>
<p>ansible和ansible-playbook默认会fork5个线程并发执行命令此时可使用-k num，根据自己主机硬件配置做调整，建议并发数是CPU的偶数倍</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible -i inventory/devlop linux-node2 -m ping ## 指定devlop组内的linux-node2主机执行ping</span><br><span class="line">ansible -i inventory/devlop &quot;~linux-node[1:3]&quot;  -m ping ##匹配正则必须~开头，匹配1和3两台机器</span><br><span class="line">ansible -i inventory/devlop &quot;~linux-node[1-3]&quot;  -m ping ## 匹配1，2，3 三台机器</span><br></pre></td></tr></table></figure>

<h3 id="后台执行"><a href="#后台执行" class="headerlink" title="后台执行"></a>后台执行</h3><p>当命令执行时间比较长时，也可以放到后台执行，使用-B(后台放置多少秒)、-P(多少秒检查一下状态)参数，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible all -B 3600-a &quot;/usr/bin/long_running_operation --do-stuff&quot; #后台执行命令3600s，-B 表示后台执行的时间</span><br><span class="line">ansible all -m async_status -a &quot;jid=123456789&quot;  #检查任务的状态</span><br><span class="line">ansible all -B 1800-P 60-a &quot;/usr/bin/long_running_operation --do-stuff&quot; #后台执行命令最大时间是1800s即30分钟，-P 每60s检查下状态，默认15s</span><br></pre></td></tr></table></figure>

<h2 id="命令执行模块"><a href="#命令执行模块" class="headerlink" title="命令执行模块"></a>命令执行模块</h2><p>命令执行模块包含如下 四个模块：</p>
<ul>
<li>command模块：该模块通过-a跟要执行的命令可以直接执行，不过命令里如果有带有如下字符部分则执行不成功 “  “&lt;”, “&gt;”, “|”,  “&amp;” ；</li>
<li>shell 模块：用法基本和command一样，不过其是通过&#x2F;bin&#x2F;sh进行执行，所以shell 模块可以执行任何命令，就像在本机执行一样；</li>
<li>raw模块：用法和shell 模块一样 ，其也可以执行任意命令，就像在本机执行一样；</li>
<li>script模块：其是将管理端的shell 在被管理主机上执行，其原理是先将shell 复制到远程主机，再在远程主机上执行，原理类似于raw模块。</li>
</ul>
<blockquote>
<p>注：raw模块和comand、shell 模块不同的是其没有chdir、creates、removes参数，chdir参数的作用就是先切到chdir指定的目录后，再执行后面的命令，这在后面很多模块里都会有该参数 。<br>shell 和 command 的区别 ：shell 支持管道命令。</p>
</blockquote>
<p>command模块包含如下选项：</p>
<ul>
<li>creates：一个文件名，当该文件存在，则该命令不执行 。</li>
<li>free_form：要执行的linux指令 。</li>
<li>chdir：在执行指令之前，先切换到该指定的目录 。</li>
<li>removes：一个文件名，当该文件不存在，则该选项不执行。</li>
<li>executable：切换shell来执行指令，该执行路径必须是一个绝对路径。</li>
</ul>
<p>使用chdir的示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.1.1 -m command -a &#x27;chdir=/tmp/test.txt touch test.file&#x27;</span><br><span class="line">ansible 192.168.1.1 -m shell -a &#x27;chdir=/tmp/test.txt touch test2.file&#x27;</span><br><span class="line">ansible 192.168.1.1 -m raw -a &#x27;chdir=/tmp/text.txt touch test3.file&#x27;</span><br></pre></td></tr></table></figure>

<p>三个命令都会返回执行成功的状态。不过实际上只有前两个文件会被创建成功。使用raw模块的执行的结果文件事实上也被正常创建了，不过不是在chdir指定的目录，而是在当前执行用户的家目录。</p>
<p>creates与removes示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.1.1 -a &#x27;creates=/tmp/server.txt uptime&#x27; #当/tmp/server.txt文件存在时，则不执行uptime指令</span><br><span class="line"></span><br><span class="line">ansible 192.168.1.1 -a &#x27;removes=/tmp/server.txt uptime&#x27; #当/tmp/server.txt文件不存在时，则不执行uptime指令</span><br></pre></td></tr></table></figure>

<p>script模块示例：</p>
<p>要执行的脚本文件script.sh内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">/bin/bash</span></span><br><span class="line">ifconfig</span><br><span class="line">df -hT</span><br></pre></td></tr></table></figure>

<p>执行ansible指令：<code>ansible 10.212.52.252 -m script -a &#39;script.sh&#39; |egrep &#39;&gt;&gt;|stdout&#39;</code></p>
<h2 id="ansible-内置模块"><a href="#ansible-内置模块" class="headerlink" title="ansible 内置模块"></a>ansible 内置模块</h2><p>根据zs官方的分类，将模块按功能分类为：云模块、命令模块、数据库模块、文件模块、资产模块、消息模块、监控模块、网络模块、通知模块、包管理模块、源码控制模块、系统模块、单元模块、web设施模块、windows模块 ，具体可以参看官方页面。</p>
<p>这里从官方分类的模块里选择最常用的一些模块进行介绍。</p>
<h3 id="ping模块"><a href="#ping模块" class="headerlink" title="ping模块"></a>ping模块</h3><p>测试主机是否是通的，用法很简单，不涉及参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m ping</span><br></pre></td></tr></table></figure>

<h3 id="setup模块"><a href="#setup模块" class="headerlink" title="setup模块"></a>setup模块</h3><p>setup模块，主要用于获取主机信息，在playbooks里经常会用到的一个参数gather_facts就与该模块相关。setup模块下经常使用的一个参数是filter参数，具体使用示例如下：</p>
<ul>
<li><code>ansible test -m setup</code>: 查看服务器的配置信息</li>
<li><code>ansible test -m setup --tree /tmp/hostlist</code>: 将主机信息保存到<code>/tmp/hostlist</code>目录中。</li>
<li><code>ansible test -m setup -a &#39;filter=ansible_eth0&#39;</code>: 过滤出eth0的网卡信息。</li>
<li><code>ansible test -m setup -a &#39;filter=ansible_*_mb&#39;</code>: 过滤出内存信息。</li>
</ul>
<h3 id="file模块"><a href="#file模块" class="headerlink" title="file模块"></a>file模块</h3><p>file模块主要用于远程主机上的文件操作，file模块包含如下选项：</p>
<ul>
<li>force：需要在两种情况下强制创建软链接，一种是源文件不存在但之后会建立的情况下；另一种是目标软链接已存在,需要先取消之前的软链，然后创建新的软链，有两个选项：yes|no 。</li>
<li>group：定义文件&#x2F;目录的属组 。</li>
<li>mode：定义文件&#x2F;目录的权限。</li>
<li>owner：定义文件&#x2F;目录的属主。</li>
<li>path：必选项，定义文件&#x2F;目录的路径。</li>
<li>recurse：递归的设置文件的属性，只对目录有效。</li>
<li>src：要被链接的源文件的路径，只应用于state&#x3D;link的情况。</li>
<li>dest：被链接到的路径，只应用于state&#x3D;link的情况 。</li>
<li>state：<ul>
<li>directory：如果目录不存在，创建目录。</li>
<li>file：即使文件不存在，也不会被创建。</li>
<li>link：创建软链接。</li>
<li>hard：创建硬链接。</li>
<li>touch：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间。</li>
<li>absent：删除目录、文件或者取消链接文件。</li>
</ul>
</li>
</ul>
<p>使用示例：</p>
<ul>
<li><code>ansible test -m file -a &#39;path=/tmp/test state=touch&#39;</code>: 创建一个文件。</li>
<li><code>ansible test -m file -a &quot;src=/etc/fstab dest=/tmp/fstab state=link&quot;</code>: 创建一个快捷方式。</li>
<li><code>ansible test -m file -a &quot;path=/tmp/fstab state=absent&quot;</code>: 删除刚才创建的快捷方式。</li>
</ul>
<h2 id="copy模块"><a href="#copy模块" class="headerlink" title="copy模块"></a>copy模块</h2><p>复制文件到远程主机，copy模块包含如下选项：</p>
<ul>
<li>backup：在覆盖之前将原文件备份，备份文件包含时间信息。有两个选项：yes|no</li>
<li>content：用于替代”src”,可以直接设定指定文件的值</li>
<li>dest：必选项。要将源文件复制到的远程主机的绝对路径，如果源文件是一个目录，那么该路径也必须是个目录</li>
<li>directory_mode：递归的设定目录的权限，默认为系统默认权限</li>
<li>force：如果目标主机包含该文件，但内容不同，如果设置为yes，则强制覆盖，如果为no，则只有当目标主机的目标位置不存在该文件时，才复制。默认为yes</li>
<li>others：所有的file模块里的选项都可以在这里使用</li>
<li>src：要复制到远程主机的文件在本地的地址，可以是绝对路径，也可以是相对路径。如果路径是一个目录，它将递归复制。在这种情况下，如果路径使用”&#x2F;“来结尾，则只复制目录里的内容，如果没有使用”&#x2F;“来结尾，则包含目录在内的整个内容全部复制，类似于rsync。</li>
</ul>
<p>示例如下：</p>
<ul>
<li><code>ansible  -s test -m copy -a &quot;src=/etc/hosts dest=/tmp/hosts owner=root group=root mode=0644&quot;</code>: 将本地的hosts拷贝到远程的<code>/tmp</code>目录下。</li>
<li><code>ansible test -m copy -a &quot;src=/etc/hosts dest=/tmp/hosts owner=root group=root mode=0644 backup=yes&quot;</code> 在目标文件存在的情况下，备份目标文件备份文件名：<code>hosts.26172.2018-06-04@14:50:10~</code>。</li>
<li><code>ansible test -m copy -a &quot;src=/mine/sudoers dest=/etc/sudoers validate=&#39;visudo -cf %s&#39;&quot;</code>: ???.</li>
</ul>
<h2 id="lineinfile模块"><a href="#lineinfile模块" class="headerlink" title="lineinfile模块"></a>lineinfile模块</h2><p>如果regexp不匹配文件中的任何一行，则将line所指定的行插入到文件的末尾。</p>
<p>示例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: Disable UseDNS</span><br><span class="line">  lineinfile: dest=/etc/ssh/sshd_config regexp=^UseDNS line=&quot;UseDNS no&quot;</span><br><span class="line">  notify:</span><br><span class="line">    - restart sshd</span><br></pre></td></tr></table></figure>

<h3 id="删除行"><a href="#删除行" class="headerlink" title="删除行"></a>删除行</h3><p>将&#x2F;tmp&#x2F;test.sh文件中所有匹配^pwd的行删除</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 templates]# ansible test -m lineinfile -a &quot;path=/tmp/test.sh regexp=&#x27;^pwd&#x27; state=absent&quot;</span><br><span class="line">172.20.21.121 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;backup&quot;: &quot;&quot;,</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;found&quot;: 3,</span><br><span class="line">    &quot;msg&quot;: &quot;3 line(s) removed&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再次运行，没有匹配行</span></span><br><span class="line">[root@centos7 templates]# ansible test -m lineinfile -a &quot;path=/tmp/test.sh regexp=&#x27;^pwd&#x27; state=absent&quot;</span><br><span class="line">172.20.21.121 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;backup&quot;: &quot;&quot;,</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;found&quot;: 0,</span><br><span class="line">    &quot;msg&quot;: &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="替换行并设置文件权限"><a href="#替换行并设置文件权限" class="headerlink" title="替换行并设置文件权限"></a>替换行并设置文件权限</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# ansible test -m lineinfile -a &quot;path=/etc/hosts regexp=&#x27;^127.0.0.1&#x27; line=&#x27;127.0.0.1 localhost&#x27; owner=root group=root mode=0644&quot;</span><br><span class="line">172.20.21.121 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;backup&quot;: &quot;&quot;,</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;msg&quot;: &quot;line replaced&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="insertafter和insertbefore"><a href="#insertafter和insertbefore" class="headerlink" title="insertafter和insertbefore"></a>insertafter和insertbefore</h3><p>当文件中没有匹配正则表达式^Listen80的行时，会将Listen 80插入到^#Listen所匹配的最后一行的后面。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# ansible test -m lineinfile -a &quot;path=/etc/httpd/conf/httpd.conf regexp=&#x27;^Listen80&#x27; insertafter=&#x27;^#Listen&#x27; line=&#x27;Listen 80&#x27;&quot;</span><br><span class="line">172.20.21.121 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;backup&quot;: &quot;&quot;,</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;msg&quot;: &quot;line added&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">insertbefore的使用方法类似</span></span><br><span class="line">[root@centos7 ~]# ansible test -m lineinfile -a &quot;path=/etc/httpd/conf/httpd.conf regexp=&#x27;^#Listen80&#x27; insertbefore=&#x27;^Listen 80&#x27; line=&#x27;#Listen 80&#x27;&quot;</span><br><span class="line">172.20.21.121 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;backup&quot;: &quot;&quot;,</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;msg&quot;: &quot;line added&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="为文件新增一行"><a href="#为文件新增一行" class="headerlink" title="为文件新增一行"></a>为文件新增一行</h3><p>直接在文件中新增一行（如果line不存在则会插入），而不通过正则表达式进行匹配。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ansible test -m lineinfile -a &quot;path=/root/test.sh line=&#x27;liuhao test&#x27;&quot;</span></span><br><span class="line">172.20.21.121 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;backup&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;line added&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次执行</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ansible test -m lineinfile -a &quot;path=/root/test.sh line=&#x27;liuhao test&#x27;&quot;</span></span><br><span class="line">172.20.21.121 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;backup&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="backrefs用法"><a href="#backrefs用法" class="headerlink" title="backrefs用法"></a>backrefs用法</h3><p>backrefs为no时，如果没有匹配，则添加一行line。如果匹配了，则把匹配内容替被换为line内容。<br>backrefs为yes时，如果没有匹配，则文件保持不变。如果匹配了，把匹配内容替被换为line内容。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ansible test -m lineinfile -a &quot;path=/root/test.sh line=&#x27;liuhao test1&#x27; regexp=&#x27;^liuhao&#x27; backrefs=yes&quot;</span></span><br><span class="line">172.20.21.121 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;backup&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;line replaced&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">[root@centos7 ~]<span class="comment"># ansible test -m lineinfile -a &quot;path=/root/test.sh line=&#x27;liuhao test1&#x27; regexp=&#x27;^liuhao2&#x27; backrefs=yes&quot;</span></span><br><span class="line">172.20.21.121 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;backup&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="blockinfile模块"><a href="#blockinfile模块" class="headerlink" title="blockinfile模块"></a>blockinfile模块</h2><p>示例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- name: change system filelimit</span><br><span class="line">  blockinfile:</span><br><span class="line">    path: /etc/security/limits.conf</span><br><span class="line">    block: |</span><br><span class="line">      *  -  nofile  65535</span><br></pre></td></tr></table></figure>

<h2 id="service模块"><a href="#service模块" class="headerlink" title="service模块"></a>service模块</h2><p>用于管理服务<br>该模块包含如下选项：</p>
<ul>
<li>arguments：给命令行提供一些选项</li>
<li>enabled：是否开机启动 yes|no</li>
<li>name：必选项，服务名称</li>
<li>pattern：定义一个模式，如果通过status指令来查看服务的状态时，没有响应，就会通过ps指令在进程中根据该模式进行查找，如果匹配到，则认为该服务依然在运行</li>
<li>runlevel：运行级别</li>
<li>sleep：如果执行了restarted，在则stop和start之间沉睡几秒钟</li>
<li>state：对当前服务执行启动，停止、重启、重新加载等操作（started,stopped,restarted,reloaded）</li>
</ul>
<p>使用示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m service -a &quot;name=httpd state=started enabled=yes&quot;</span><br><span class="line">asnible test -m service -a &quot;name=foo pattern=/usr/bin/foo state=started&quot;</span><br><span class="line">ansible test -m service -a &quot;name=network state=restarted args=eth0&quot;</span><br></pre></td></tr></table></figure>

<h2 id="systemd模块"><a href="#systemd模块" class="headerlink" title="systemd模块"></a>systemd模块</h2><p>systemd模块用于控制远程主机的systemd服务，说白了，就是Linux下的systemd命令。需要远程主机支持systemd。</p>
<p>用法和service模块基本相同。</p>
<p>模块参数</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Make</span> <span class="string">sure</span> <span class="string">a</span> <span class="string">service</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line">  <span class="attr">systemd:</span> <span class="string">state=started</span> <span class="string">name=httpd</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">stop</span> <span class="string">service</span> <span class="string">cron</span> <span class="string">on</span> <span class="string">debian,</span> <span class="string">if</span> <span class="string">running</span></span><br><span class="line">  <span class="attr">systemd:</span> <span class="string">name=cron</span> <span class="string">state=stopped</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">service</span> <span class="string">cron</span> <span class="string">on</span> <span class="string">centos,</span> <span class="string">in</span> <span class="string">all</span> <span class="string">cases,</span> <span class="string">also</span> <span class="string">issue</span> <span class="string">daemon-reload</span> <span class="string">to</span> <span class="string">pick</span> <span class="string">up</span> <span class="string">config</span> <span class="string">changes</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">    <span class="attr">daemon_reload:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">crond</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">reload</span> <span class="string">service</span> <span class="string">httpd,</span> <span class="string">in</span> <span class="string">all</span> <span class="string">cases</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">reloaded</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">enable</span> <span class="string">service</span> <span class="string">httpd</span> <span class="string">and</span> <span class="string">ensure</span> <span class="string">it</span> <span class="string">is</span> <span class="string">not</span> <span class="string">masked</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">masked:</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">enable</span> <span class="string">a</span> <span class="string">timer</span> <span class="string">for</span> <span class="string">dnf-automatic</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dnf-automatic.timer</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">just</span> <span class="string">force</span> <span class="string">systemd</span> <span class="string">to</span> <span class="string">reread</span> <span class="string">configs</span> <span class="string">(2.4</span> <span class="string">and</span> <span class="string">above)</span></span><br><span class="line">  <span class="attr">systemd:</span> <span class="string">daemon_reload=yes</span></span><br></pre></td></tr></table></figure>

<h2 id="cron模块"><a href="#cron模块" class="headerlink" title="cron模块"></a>cron模块</h2><p>用于管理计划任务包含如下选项：</p>
<ul>
<li>backup：对远程主机上的原任务计划内容修改之前做备份。</li>
<li>cron_file：如果指定该选项，则用该文件替换远程主机上的cron.d目录下的用户的任务计划。</li>
<li>day：日（1-31，<em>，</em>&#x2F;2,……）。</li>
<li>hour：小时（0-23，<em>，</em>&#x2F;2，……） 。</li>
<li>minute：分钟（0-59，<em>，</em>&#x2F;2，……）。</li>
<li>month：月（1-12，<em>，</em>&#x2F;2，……）。</li>
<li>weekday：周（0-7，*，……）。</li>
<li>job：要执行的任务，依赖于state&#x3D;present。</li>
<li>name：该任务的描述。</li>
<li>special_time：指定什么时候执行，参数：reboot,yearly,annually,monthly,weekly,daily,hourly。</li>
<li>state：确认该任务计划是创建还是删除。</li>
<li>user：以哪个用户的身份执。</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m cron -a &#x27;name=&quot;a job for reboot&quot; special_time=reboot job=&quot;/some/job.sh&quot;&#x27;</span><br><span class="line">ansible test -m cron -a &#x27;name=&quot;yum autoupdate&quot; weekday=&quot;2&quot; minute=0 hour=12 user=&quot;root&quot;</span><br><span class="line">ansible test -m cron  -a &#x27;backup=&quot;True&quot; name=&quot;test&quot; minute=&quot;0&quot; hour=&quot;5,2&quot; job=&quot;ls -alh &gt; /dev/null&quot;&#x27;</span><br><span class="line">ansilbe test -m cron -a &#x27;cron_file=ansible_yum-autoupdate state=absent&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="yum模块"><a href="#yum模块" class="headerlink" title="yum模块"></a>yum模块</h2><p>使用yum包管理器来管理软件包，其选项有：</p>
<ul>
<li>config_file：yum的配置文件 。</li>
<li>disable_gpg_check：关闭gpg_check 。</li>
<li>disablerepo：不启用某个源 。</li>
<li>enablerepo：启用某个源。</li>
<li>name：要进行操作的软件包的名字，也可以传递一个url或者一个本地的rpm包的路径 。</li>
<li>state：状态（present(当前版本)，absent(删除)，latest）。</li>
</ul>
<p>示例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m yum -a &#x27;name=httpd state=latest&#x27;</span><br><span class="line">ansible test -m yum -a &#x27;name=&quot;@Development tools&quot; state=present&#x27;</span><br><span class="line">ansible test -m yum -a &#x27;name=http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm state=present&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="user模块与group模块"><a href="#user模块与group模块" class="headerlink" title="user模块与group模块"></a>user模块与group模块</h2><p>user模块是请求的是useradd, userdel, usermod三个指令。<br>goup模块请求的是groupadd, groupdel, groupmod 三个指令。</p>
<h3 id="user模块"><a href="#user模块" class="headerlink" title="user模块"></a>user模块</h3><ul>
<li>home：指定用户的家目录，需要与createhome配合使用.</li>
<li>groups：指定用户的属组.</li>
<li>uid：指定用的uid.</li>
<li>password：指定用户的密码.</li>
<li>name：指定用户名.</li>
<li>createhome：是否创建家目录 yes|no.</li>
<li>system：是否为系统用户.</li>
<li>remove：当state&#x3D;absent时，remove&#x3D;yes则表示连同家目录一起删除，等价于userdel -r.</li>
<li>state：是创建还是删除.</li>
<li>shell：指定用户的shell环境.</li>
</ul>
<p>使用示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user: name=johnd comment=&quot;John Doe&quot; uid=1040 group=admin</span><br><span class="line">user: name=james shell=/bin/bash groups=admins,developers append=yes user: name=johnd state=absent remove=yes</span><br><span class="line">user: name=james18 shell=/bin/zsh groups=developers expires=1422403387</span><br><span class="line">user: name=test generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa    #生成密钥时，只会生成公钥文件和私钥文件，和直接使用ssh-keygen指令效果相同，不会生成authorized_keys文件。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：指定password参数时，不能使用明文密码，因为后面这一串密码会被直接传送到被管理主机的&#x2F;etc&#x2F;shadow文件中，所以需要先将密码字符串进行加密处理。然后将得到的字符串放到password中即可。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;123456&quot;</span> | openssl passwd -1 -salt $(&lt; /dev/urandom <span class="built_in">tr</span> -dc <span class="string">&#x27;[:alnum:]&#x27;</span> | <span class="built_in">head</span> -c 32) -stdin</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1$guC5vhaV$/Ypvq7uxwpwFjoGKLRgZw1</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### 使用上面的密码创建用户</span></span></span><br><span class="line">ansible all -m user -a &#x27;name=foo password=&quot;$1$4P4PlFuE$ur9ObJiT5iHNrb9QnjaIB0&quot;&#x27;</span><br></pre></td></tr></table></figure>

<p>不同的发行版默认使用的加密方式可能会有区别，具体可以查看&#x2F;etc&#x2F;login.defs文件确认，centos 6.5版本使用的是SHA512加密算法。</p>
<h4 id="password-密码生成"><a href="#password-密码生成" class="headerlink" title="password 密码生成"></a>password 密码生成</h4><p>两种方法设置用户名和密码</p>
<p>第一种 使用ansible自带的函数设置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">&quot;`hosts`&quot;</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Change</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">password=&#123;&#123;</span> <span class="string">user_pass</span> <span class="string">|</span> <span class="string">password_hash(&#x27;sha512&#x27;)</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">with_items:</span> <span class="string">users</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## 执行，123456 就是密码</span></span></span><br><span class="line">ansible-playbook testuser.yml -e &quot;hosts=jump users=testuser user_pass=*(123456)&quot;</span><br></pre></td></tr></table></figure>

<p>2、第二种 使用python模块先加密完成</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> 2.2 调用crypt 模块</span><br><span class="line"></span><br><span class="line">    (只用于 Unix)实现了单向的 DES 加密, Unix 系统使用这个加密算法来储存密码。</span><br><span class="line"></span><br><span class="line">[root@hrserver1 user]# python -c &#x27;import crypt; print crypt.crypt(&quot;hh4213&quot;, &quot;hadoop&quot;)&#x27;</span><br><span class="line">haHAfV7dvUhpM</span><br><span class="line"> 2.3 得到加密算法密码haHAfV7dvUhpM代入剧本password</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">        <span class="comment"># created with:</span></span><br><span class="line">        <span class="comment">#   python -c &#x27;python -c &#x27;import crypt; print crypt.crypt(&quot;hh4213&quot;, &quot;hadoop&quot;)&#x27;</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">haHAfV7dvUhpM</span></span><br><span class="line">    <span class="attr">tasks:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">user:</span> <span class="string">name=hruser</span> <span class="string">password=`password`</span> <span class="string">update_password=always</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">## 执行</span></span></span><br><span class="line">ansible-playbook  user_pass.yml -v</span><br></pre></td></tr></table></figure>

<h3 id="group模块"><a href="#group模块" class="headerlink" title="group模块"></a>group模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m group -a &#x27;name=somegroup state=present&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="synchronize模块"><a href="#synchronize模块" class="headerlink" title="synchronize模块"></a>synchronize模块</h2><p>使用 ansible synchronize_module 可以控制机和目标机之间同步目录<br>使用rsync同步文件，其参数如下：</p>
<ul>
<li>archive: 归档，相当于同时开启recursive(递归)、links、perms、times、owner、group、-D选项都为yes ，默认该项为开启.</li>
<li>checksum: 跳过检测sum值，默认关闭.</li>
<li>compress:是否开启压缩.</li>
<li>copy_links：复制链接文件，默认为no ，注意后面还有一个links参数.</li>
<li>delete: 删除不存在的文件，默认no.</li>
<li>dest：目录路径.</li>
<li>dest_port：默认目录主机上的端口 ，默认是22，走的ssh协议.</li>
<li>dirs：传速目录不进行递归，默认为no，即进行目录递归.</li>
<li>rsync_opts：rsync参数部分.</li>
<li>set_remote_user：主要用于&#x2F;etc&#x2F;ansible&#x2F;hosts中定义或默认使用的用户与rsync使用的用户不同的情况.</li>
<li>mode: push或pull 模块，push的话，一般用于从本机向远程主机上传文件，pull 模式用于从远程主机上取文件，默认push模式.</li>
</ul>
<p>使用示例：</p>
<p>推送 push</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m synchronize -a &#x27;src=some/relative/path dest=/some/absolute/path rsync_path=&quot;sudo rsync&quot; &#x27;</span><br><span class="line">ansible test -m synchronize -a &#x27;src=some/relative/path dest=/some/absolute/path archive=no links=yes &#x27;</span><br><span class="line">ansible test -m synchronize -a &#x27;src=some/relative/path dest=/some/absolute/path checksum=yes times=no &#x27;</span><br></pre></td></tr></table></figure>

<p>拉取 pull</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m synchronize -a &#x27;src=/tmp/helloworld dest=/var/www/helloword rsync_opts=--no-motd,--exclude=.git mode=pull &#x27;</span><br></pre></td></tr></table></figure>

<h3 id="synchronize-结合-CD参数"><a href="#synchronize-结合-CD参数" class="headerlink" title="synchronize 结合-CD参数"></a>synchronize 结合-CD参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.d..t...... ./</span><br><span class="line">&lt;f..tpog... jr-sta.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>t: 表示修改了时间。</li>
<li>p: 表示修改了权限。</li>
<li>o: 表示修改了user。</li>
<li>g: 表示修改了group。</li>
<li>s: 表示修改了大小。</li>
</ul>
<p>Explanation of each bit position and value in rsync’s output:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">YXcstpoguax  path/to/file</span><br><span class="line">|||||||||||</span><br><span class="line">||||||||||╰- x: The extended attribute information changed</span><br><span class="line">|||||||||╰-- a: The ACL information changed</span><br><span class="line">||||||||╰--- u: The u slot is reserved for future use</span><br><span class="line">|||||||╰---- g: Group is different</span><br><span class="line">||||||╰----- o: Owner is different</span><br><span class="line">|||||╰------ p: Permission are different</span><br><span class="line">||||╰------- t: Modification time is different</span><br><span class="line">|||╰-------- s: Size is different</span><br><span class="line">||╰--------- c: Different checksum (for regular files), or</span><br><span class="line">||              changed value (for symlinks, devices, and special files)</span><br><span class="line">|╰---------- the file type:</span><br><span class="line">|            f: for a file,</span><br><span class="line">|            d: for a directory,</span><br><span class="line">|            L: for a symlink,</span><br><span class="line">|            D: for a device,</span><br><span class="line">|            S: for a special file (e.g. named sockets and fifos)</span><br><span class="line">╰----------- the type of update being done::</span><br><span class="line">             &lt;: file is being transferred to the remote host (sent)</span><br><span class="line">             &gt;: file is being transferred to the local host (received)</span><br><span class="line">             c: local change/creation for the item, such as:</span><br><span class="line">                - the creation of a directory</span><br><span class="line">                - the changing of a symlink,</span><br><span class="line">                - etc.</span><br><span class="line">             h: the item is a hard link to another item (requires</span><br><span class="line">                --hard-links).</span><br><span class="line">             .: the item is not being updated (though it might have</span><br><span class="line">                attributes that are being modified)</span><br><span class="line">             *: means that the rest of the itemized-output area contains</span><br><span class="line">                a message (e.g. &quot;deleting&quot;)</span><br></pre></td></tr></table></figure>

<h2 id="filesystem模块"><a href="#filesystem模块" class="headerlink" title="filesystem模块"></a>filesystem模块</h2><p>在块设备上创建文件系统</p>
<ul>
<li>dev：目标块设备.</li>
<li>force：在一个已有文件系统 的设备上强制创建.</li>
<li>fstype：文件系统的类型.</li>
<li>opts：传递给mkfs命令的选项.</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m filesystem -a &#x27;fstype=ext2 dev=/dev/sdb1 force=yes&#x27;</span><br><span class="line"></span><br><span class="line">ansible test -m filesystem -a &#x27;fstype=ext4 dev=/dev/sdb1 opts=&quot;-cc&quot;&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="mount模块"><a href="#mount模块" class="headerlink" title="mount模块"></a>mount模块</h2><p>配置挂载点</p>
<ul>
<li>fstype：必选项，挂载文件的类型.</li>
<li>name：必选项，挂载点.</li>
<li>opts：传递给mount命令的参数.</li>
<li>src：必选项，要挂载的文件.</li>
<li>state：必选项.<ul>
<li>present：只在fstab中写入配置。</li>
<li>absent：删除挂载点。</li>
<li>mounted：自动创建挂载点并挂载, 同时写入fstab。</li>
<li>umounted：卸载。</li>
</ul>
</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name=/mnt/dvd src=/dev/sr0 fstype=iso9660 opts=ro state=present</span><br><span class="line">name=/srv/disk src=&#x27;LABEL=SOME_LABEL&#x27; state=present</span><br><span class="line">name=/home src=&#x27;UUID=b3e48f45-f933-4c8e-a700-22a159ec9077&#x27; opts=noatime state=present</span><br></pre></td></tr></table></figure>

<p>ansible 创建一个硬盘并挂载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible test -a &#x27;dd if=/dev/zero of=/disk.img bs=4k count=1024&#x27;</span><br><span class="line">ansible test -a &#x27;losetup /dev/loop0 /disk.img&#x27;</span><br><span class="line">ansible test -m filesystem &#x27;fstype=ext4 force=yes opts=-F dev=/dev/loop0&#x27;</span><br><span class="line">ansible test -m mount &#x27;name=/mnt src=/dev/loop0 fstype=ext4 state=mounted opts=rw&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="get-url-模块"><a href="#get-url-模块" class="headerlink" title="get_url 模块"></a>get_url 模块</h2><p>该模块主要用于从http、ftp、https服务器上下载文件（类似于wget），主要有如下选项：</p>
<ul>
<li>sha256sum：下载完成后进行sha256 check.</li>
<li>timeout：下载超时时间，默认10s.</li>
<li>url：下载的URL.</li>
<li>url_password、url_username：主要用于需要用户名密码进行验证的情况.</li>
<li>use_proxy：是事使用代理，代理需事先在环境变更中定义.</li>
</ul>
<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">get_url: url=http://example.com/path/file.conf dest=/etc/foo.conf mode=0440</span><br><span class="line">get_url: url=http://example.com/path/file.conf dest=/etc/foo.conf sha256sum=b5bb9d8014a0f9b1d61e21e796d78dccdf1352f23cd32812f4850b878ae4944c</span><br></pre></td></tr></table></figure>

<h2 id="unarchive模块"><a href="#unarchive模块" class="headerlink" title="unarchive模块"></a>unarchive模块</h2><p>用于解压文件，模块包含如下选项：</p>
<ul>
<li>copy：在解压文件之前，是否先将文件复制到远程主机，默认为yes。若为no，则要求目标主机上压缩包必须存在。</li>
<li>creates：指定一个文件名，当该文件存在时，则解压指令不执行。</li>
<li>dest：远程主机上的一个路径，即文件解压的路径 。</li>
<li>grop：解压后的目录或文件的属组。</li>
<li>list_files：如果为yes，则会列出压缩包里的文件，默认为no，2.0版本新增的选项。</li>
<li>mode：解决后文件的权限。</li>
<li>src：如果copy为yes，则需要指定压缩文件的源路径 。</li>
<li>owner：解压后文件或目录的属主。</li>
</ul>
<p>示例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- unarchive: src=foo.tgz dest=/var/lib/foo</span><br><span class="line">- unarchive: src=/tmp/foo.zip dest=/usr/local/bin copy=no</span><br><span class="line">- unarchive: src=https://example.com/example.zip dest=/usr/local/bin copy=no</span><br></pre></td></tr></table></figure>

<h2 id="sysctl模块"><a href="#sysctl模块" class="headerlink" title="sysctl模块"></a>sysctl模块</h2><p>示例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: set sysctl</span><br><span class="line">  sysctl: name=&#123;&#123; item.name &#125;&#125; value=&#123;&#123; item.value &#125;&#125; state=present</span><br><span class="line">  with_items:</span><br><span class="line">    - &#123; name: vm.max_map_count, value: 262144 &#125;</span><br></pre></td></tr></table></figure>

<h2 id="authorized-key-模块"><a href="#authorized-key-模块" class="headerlink" title="authorized_key 模块"></a>authorized_key 模块</h2><p>用于向远程主机的某个账户的authorized_keys文件中增加公钥 或 从中移除公钥。</p>
<ul>
<li><p>exclusive: 是否从authorized_keys文件中移除所有其他的未指定的公钥。当想要指定多个公钥的时候，可以将key参数指定为 新行 分隔的公钥列表。需要注意的是，当使用with_*的时候，每次迭代都会进行移除操作。(Choices: yes, no)[Default: no]</p>
</li>
<li><p>key: ssh公钥。可以是一个字符串，也可以是一个url。</p>
</li>
<li><p>manage_dir: 是否管理authorized_keys文件所在的目录。如果设置了这个选项，那么authorized_key模块，会创建这个目录，并且会设置目录的所有者和权限。(Choices: yes, no)[Default: yes]</p>
</li>
<li><p>path: 给authorized_keys文件设置一个替代的路径。[Default: (homedir)+&#x2F;.ssh&#x2F;authorized_keys]</p>
</li>
<li><p>state: present表示添加公钥，absent表示删除公钥。</p>
</li>
<li><p>user: 远程主机上的用户名。</p>
</li>
<li><p>validate_certs: 只有key的值是https url的时候，才起作用。如果设置该选项为no，那么不会校验SSL证书。(Choices: yes, no)[Default: yes]</p>
</li>
</ul>
<p>例子</p>
<p>使用管理机上的本地文件的例子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">authorized_key:</span> <span class="string">user=charlie</span> <span class="string">key=&quot;&#123;&#123;</span> <span class="string">lookup(&#x27;file&#x27;,</span> <span class="string">&#x27;/home/charlie/.ssh/id_rsa.pub&#x27;</span><span class="string">)</span> <span class="string">&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>使用github url作为key的来源</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">authorized_key:</span> <span class="string">user=charlie</span> <span class="string">key=https://github.com/charlie.keys</span></span><br></pre></td></tr></table></figure>

<p>给authorized_keys文件指定一个替代的路径</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">authorized_key:</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">charlie</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;file&#x27;, &#x27;/home/charlie/.ssh/id_rsa.pub&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&#x27;/etc/ssh/authorized_keys/charlie&#x27;</span></span><br><span class="line">    <span class="attr">manage_dir:</span> <span class="literal">no</span></span><br></pre></td></tr></table></figure>

<p>使用with_file循环</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">authorized_keys</span> <span class="string">for</span> <span class="string">the</span> <span class="string">deploy</span> <span class="string">user</span></span><br><span class="line">  <span class="attr">authorized_key:</span> <span class="string">user=deploy</span> <span class="string">key=&quot;&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;&quot;</span></span><br><span class="line">  <span class="attr">with_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">public_keys/doe-jane</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">public_keys/doe-john</span></span><br></pre></td></tr></table></figure>

<p>使用ssh key选项</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">authorized_key:</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">charlie</span></span><br><span class="line">    <span class="attr">key:</span>  <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;file&#x27;, &#x27;/home/charlie/.ssh/id_rsa.pub&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">key_options:</span> <span class="string">&#x27;no-port-forwarding,from=&quot;10.0.1.1&quot;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>使用validate_certs</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">authorized_key:</span> <span class="string">user=charlie</span> <span class="string">key=https://github.com/user.keys</span> <span class="string">validate_certs=no</span></span><br></pre></td></tr></table></figure>

<p>向远程主机的root用户的authorized_keys文件中，增加本地的public_keys&#x2F;doe-jane文件中列出的公钥列表，并删除不在这个列表中的公钥</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">authorized_key:</span> <span class="string">user=root</span> <span class="string">key=&quot;&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;&quot;</span> <span class="string">state=present</span> <span class="string">exclusive=yes</span></span><br><span class="line">  <span class="attr">with_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">public_keys/doe-jane</span></span><br></pre></td></tr></table></figure>

<p>将正在运行ansible的用户的主目录下的.ssh&#x2F;id_rsa.pub文件里的公钥拷贝到远程主机的ubuntu用户的authorized_keys文件中</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">authorized_key:</span> <span class="string">user=ubuntu</span> <span class="string">key=&quot;&#123;&#123;</span> <span class="string">lookup(&#x27;file&#x27;,</span> <span class="string">lookup(&#x27;env&#x27;,&#x27;HOME&#x27;)</span> <span class="string">+</span> <span class="string">&#x27;/.ssh/id_rsa.pub&#x27;</span><span class="string">)</span> <span class="string">&#125;&#125;&quot;</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a target="_blank" rel="noopener" href="https://tangx.in/2017/04/12/ansible-copy-directories-to-remote-hosts-synchronize_module/#ansible-synchronize-%E5%90%8C%E6%AD%A5%E6%96%87%E4%BB%B6%E5%A4%B9">ansible synchronize 同步文件夹</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2018/09/14/ansible-config/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/09/14/ansible-config/" class="post-title-link" itemprop="url">死磕ansible系列--修改cfg配置文件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-09-14 20:18:33" itemprop="dateCreated datePublished" datetime="2018-09-14T20:18:33+08:00">2018-09-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-10-10 11:24:12" itemprop="dateModified" datetime="2020-10-10T11:24:12+08:00">2020-10-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/ansible/" itemprop="url" rel="index"><span itemprop="name">ansible</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>ansible 读取文件的顺序</p>
<ol>
<li><code>export ANSIBLE_CONFIG</code>：首先，Ansible命令会检查环境变量，及这个环境变量将指向的配置文件 。</li>
<li><code>./ansible.cfg</code>：其次，将会检查当前目录下的ansible.cfg配置文件。</li>
<li><code>~/.ansible.cfg</code>：再次，将会检查当前用户home目录下的.ansible.cfg配置文件。</li>
<li><code>/etc/ansible/ansible.cfg</code>：最后，将会检查在用软件包管理工具安装Ansible时自动产生的配置文件。</li>
</ol>
<blockquote>
<p>Ansible默认安装好后有一个配置文件<code>/etc/ansible/ansible.cfg</code>，该配置文件中定义了ansible的主机的默认配置部分，如默认是否需要输入密码、是否开启sudo认证、action_plugins插件的位置、hosts主机组的位置、是否开启log功能、默认端口、key文件位置等等。</p>
</blockquote>
<p>具体如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">some basic default values...</span></span><br><span class="line">hostfile       = /etc/ansible/hosts   \\指定默认hosts配置的位置</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">library_path = /usr/share/my_modules/</span></span><br><span class="line">remote_tmp     = $HOME/.ansible/tmp</span><br><span class="line">pattern        = *</span><br><span class="line">forks          = 5</span><br><span class="line">poll_interval  = 15</span><br><span class="line">sudo_user      = root  \\远程sudo用户</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ask_sudo_pass = True  \\每次执行ansible命令是否询问ssh密码</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ask_pass      = True  \\每次执行ansible命令时是否询问sudo密码</span></span><br><span class="line">transport      = smart</span><br><span class="line">remote_port    = 22</span><br><span class="line">module_lang    = C</span><br><span class="line">gathering = implicit</span><br><span class="line">host_key_checking = False    \\关闭第一次使用ansible连接客户端是输入命令提示</span><br><span class="line">log_path    = /var/log/ansible.log \\需要时可以自行添加。chown -R root:root ansible.log</span><br><span class="line">system_warnings = False    \\关闭运行ansible时系统的提示信息，一般为提示升级</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> plugin path directories here, separate with colons</span></span><br><span class="line">action_plugins     = /usr/share/ansible_plugins/action_plugins</span><br><span class="line">callback_plugins   = /usr/share/ansible_plugins/callback_plugins</span><br><span class="line">connection_plugins = /usr/share/ansible_plugins/connection_plugins</span><br><span class="line">lookup_plugins     = /usr/share/ansible_plugins/lookup_plugins</span><br><span class="line">vars_plugins       = /usr/share/ansible_plugins/vars_plugins</span><br><span class="line">filter_plugins     = /usr/share/ansible_plugins/filter_plugins</span><br><span class="line">fact_caching = memory</span><br><span class="line">[accelerate]</span><br><span class="line">accelerate_port = 5099</span><br><span class="line">accelerate_timeout = 30</span><br><span class="line">accelerate_connect_timeout = 5.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The daemon <span class="built_in">timeout</span> is measured <span class="keyword">in</span> minutes. This time is measured</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">from the last activity to the accelerate daemon.</span></span><br><span class="line">accelerate_daemon_timeout = 30</span><br></pre></td></tr></table></figure>

<h2 id="其他参数"><a href="#其他参数" class="headerlink" title="其他参数"></a>其他参数</h2><p>默认ansible 执行的时候，并不会输出日志到文件，不过在ansible.cfg 配置文件中有如下行：</p>
<p>log_path &#x3D; &#x2F;var&#x2F;log&#x2F;ansible.log<br>默认log_path这行是注释的，打开该行的注释，所有的命令执行后，都会将日志输出到&#x2F;var&#x2F;log&#x2F;ansible.log文件。</p>
<h2 id="DEFAULT-ROLES-PATH"><a href="#DEFAULT-ROLES-PATH" class="headerlink" title="DEFAULT_ROLES_PATH"></a>DEFAULT_ROLES_PATH</h2><p>roles 查找路径<br>Description:	Colon separated paths in which Ansible will search for Roles.<br>Type:	pathspec<br>Default:	~&#x2F;.ansible&#x2F;roles:&#x2F;usr&#x2F;share&#x2F;ansible&#x2F;roles:&#x2F;etc&#x2F;ansible&#x2F;roles<br>Ini Section:	defaults<br>Ini Key:	roles_path<br>Environment:	ANSIBLE_ROLES_PATH</p>
<p>我们可以在自己的仓库中自定义<br><code>DEFAULT_ROLES_PATH： roles:roles/www/</code></p>
<h2 id="报错汇总"><a href="#报错汇总" class="headerlink" title="报错汇总"></a>报错汇总</h2><h3 id="如果在对之前未连接的主机进行连结时报错"><a href="#如果在对之前未连接的主机进行连结时报错" class="headerlink" title="如果在对之前未连接的主机进行连结时报错"></a>如果在对之前未连接的主机进行连结时报错</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible test -a &#x27;uptime&#x27;</span><br><span class="line">    192.168.56.12| FAILED =&gt;Using a SSH password instead of a key is not possible because HostKey checking is enabled and sshpass does not support this.Please add this host&#x27;s fingerprint to your known_hosts file to manage this host.</span><br></pre></td></tr></table></figure>

<p>是由于在本机的<code>~/.ssh/known_hosts</code>文件中并有fingerprint key串，ssh第一次连接的时候一般会提示输入yes 进行确认为将key字符串加入到<code>~/.ssh/known_hosts </code>文件中。</p>
<p>解决办法：<br>方法一：<br>在进行ssh连接时，可以使用-o参数将StrictHostKeyChecking设置为no，使用ssh连接时避免首次连接时让输入yes&#x2F;no部分的提示。通过查看ansible.cfg配置文件，发现如下行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[ssh_connection]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ssh arguments to use</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Leaving off ControlPersist will result <span class="keyword">in</span> poor performance, so use</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">paramiko on older platforms rather than removing it</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ssh_args = -o ControlMaster=auto -o ControlPersist=60s</span></span><br><span class="line">可以启用ssh_args 部分，使用下面的配置，避免上面出现的错误：</span><br><span class="line"></span><br><span class="line">ssh_args = -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking＝no</span><br></pre></td></tr></table></figure>

<p>方法2：<br>在ansible.cfg配置文件中，也会找到如下配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">uncomment this to <span class="built_in">disable</span> SSH key host checking</span></span><br><span class="line">host_key_checking = False</span><br></pre></td></tr></table></figure>

<p>默认host_key_checking部分是注释的，通过找开该行的注释，同样也可以实现跳过ssh 首次连接提示验证部分。但在实际测试中，似乎并没有效果，建议使用方法1.</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/reference_appendices/config.html">ansible config</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2018/09/14/ansible-playbook/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/09/14/ansible-playbook/" class="post-title-link" itemprop="url">死磕ansible系列--playbook</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-09-14 20:18:33" itemprop="dateCreated datePublished" datetime="2018-09-14T20:18:33+08:00">2018-09-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-10-10 11:24:27" itemprop="dateModified" datetime="2020-10-10T11:24:27+08:00">2020-10-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/ansible/" itemprop="url" rel="index"><span itemprop="name">ansible</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>playbook是由一个或多个“play”组成的列表。play的主要功能在于将事先归并为一组的主机装扮成事先通过ansible中的task定义好的角色。从根本上来讲，所谓task无非是调用ansible的一个module。将多个play组织在一个playbook中，即可以让它们联合起来按事先编排的机制完成某一任务。</p>
<p>playbook 分为四大任务块：</p>
<ul>
<li>Target section: 定义将要执行playbook的远程主机组。</li>
<li>Variable section: 定义playbook运行时需要使用的变量。</li>
<li>Task section: 定义将要在远程主机上执行的任务列表。</li>
<li>Handler section: 定义task执行完成以后需要调用的任务。</li>
</ul>
<p>一个完整的例子：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- hosts: mfs_node</span><br><span class="line">  user: root</span><br><span class="line">  vars:</span><br><span class="line">      - motd_warning: &#x27;WARNING: Use by ACME Employees ONLY&#x27;</span><br><span class="line">  tasks:</span><br><span class="line">      - name: setup a MOTD</span><br><span class="line">        copy: dest=/etc/motd content=&quot;&#123;&#123; motd_warning &#125;&#125;&quot;</span><br><span class="line">        notify: say someting</span><br><span class="line">   handlers:</span><br><span class="line">        - name: say someting</span><br><span class="line">	 command: echo &quot;copy OK&quot;</span><br></pre></td></tr></table></figure>

<h2 id="命令行执行"><a href="#命令行执行" class="headerlink" title="命令行执行"></a>命令行执行</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i inventory/devlop site.yaml</span><br><span class="line">ansible-playbook -i inventory/devlop site.yaml -l linux-node2</span><br><span class="line">ansible-playbook -i inventory/devlop -e target=gsg_tmp -e role=php56 role.yml</span><br></pre></td></tr></table></figure>

<h3 id="ansible-playbook-常用参数"><a href="#ansible-playbook-常用参数" class="headerlink" title="ansible-playbook 常用参数"></a>ansible-playbook 常用参数</h3><ul>
<li>-C ：只显示哪些有变更，但是不执行任何参数。</li>
<li>-D： 通常和-C参数一起使用，显示变化的内容。</li>
<li>-t：匹配tags。</li>
<li>-e: 增加扩展的参数。</li>
<li>-v: 显示详细内容。</li>
<li>-vvv: 显示更详细的内容。</li>
</ul>
<h2 id="Target-section"><a href="#Target-section" class="headerlink" title="Target section"></a>Target section</h2><ul>
<li>hosts：定义远程的主机组。</li>
<li>user：执行该任务组的用户。</li>
<li>remote_user：与user相同。</li>
<li>sudo：如果设置为yes，执行该任务组的用户在执行任务的时候，获取root权限。</li>
<li>sudo_user：如果你设置user为tom，sudo为yes，sudo_user为jerry，则tom用户则会获取jerry用户的权限。</li>
<li>connection：通过什么方式连接到远程主机，默认为ssh。</li>
<li>gather_facts：除非你明确说明不需要在远程主机上执行setup模块，否则默认会自动执行。如果你确实不需要setup模块所传递过来的变量，你可以启用该选项。</li>
</ul>
<h2 id="Variable-section"><a href="#Variable-section" class="headerlink" title="Variable section"></a>Variable section</h2><p>vars<br>vars_files<br>vars_prompt<br>setup</p>
<h2 id="Task-section"><a href="#Task-section" class="headerlink" title="Task section"></a>Task section</h2><h3 id="task任务的编写方法"><a href="#task任务的编写方法" class="headerlink" title="task任务的编写方法"></a>task任务的编写方法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">    - name: install apache</span><br><span class="line">       action: yum name=httpd state=installed     #第一种方法</span><br><span class="line"></span><br><span class="line">    - name: configure apache</span><br><span class="line">       copy: src=files/httpd.conf dest=/etc/httpd/conf/httpd.conf    #第二种方法</span><br><span class="line"></span><br><span class="line">    - name: restart apache</span><br><span class="line">       service:</span><br><span class="line">            name: httpd</span><br><span class="line">            state: restarted                         #第三种方法</span><br></pre></td></tr></table></figure>

<h3 id="task任务中的常用模块"><a href="#task任务中的常用模块" class="headerlink" title="task任务中的常用模块"></a>task任务中的常用模块</h3><h4 id="template"><a href="#template" class="headerlink" title="template"></a>template</h4><p>template模块是Ansible中最常用的模块之一。它可以让你设计一个框架式的配置文件，如何把Anisble需要的值插入到合适的位置。其中Jinja2模板尤为复杂，其中可以包含条件、循环、宏。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">    - name: copy config file to remote server</span><br><span class="line">      template: src=named.conf.j2 dest=/etc/named.conf</span><br></pre></td></tr></table></figure>

<p>named.conf.j2 模板的内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&#123;&#123; ansible_managed &#125;&#125;</span></span><br><span class="line">options &#123;</span><br><span class="line">listen-on port 53 &#123;</span><br><span class="line">127.0.0.1;</span><br><span class="line">&#123;% for ip in ansible_all_ipv4_addresses %&#125;</span><br><span class="line">&#123;&#123; ip &#125;&#125;;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&#125;;</span><br><span class="line">listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">directory &quot;/var/named&quot;;</span><br><span class="line">dump-file &quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">type hint;</span><br><span class="line">file &quot;named.ca&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">include &quot;/etc/named.rfc1912.zones&quot;;</span><br><span class="line">include &quot;/etc/named.root.key&quot;;</span><br><span class="line">&#123;# Variables for zone config #&#125;</span><br><span class="line"></span><br><span class="line">&#123;% if &#x27;authorativenames&#x27; in group_names %&#125;</span><br><span class="line">&#123;% set zone_type = &#x27;master&#x27; %&#125;</span><br><span class="line">&#123;% set zone_dir = &#x27;data&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">&#123;% set zone_type = &#x27;slave&#x27; %&#125;</span><br><span class="line">&#123;% set zone_dir = &#x27;slaves&#x27; %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">zone &quot;internal.example.com&quot; IN &#123;</span><br><span class="line">type &#123;&#123; zone_type &#125;&#125;;</span><br><span class="line">file &quot;&#123;&#123; zone_dir &#125;&#125;/internal.example.com&quot;;</span><br><span class="line"></span><br><span class="line">&#123;% if &#x27;authorativenames&#x27; not in group_names %&#125;</span><br><span class="line">masters &#123; 192.168.2.2; &#125;;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="set-fact"><a href="#set-fact" class="headerlink" title="set_fact"></a>set_fact</h4><p>set_fact模块可以让你在远程受管机器上执行脚本的过程中来计算我们需要的值，这些值可以被用在模板或者变量中。这些值有点类似setup模块中的参数，只不过setup模块是以单台主机为单位的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- hosts: mysqlservers</span><br><span class="line">  tasks:</span><br><span class="line">    - name: install MySql</span><br><span class="line">    yum: name=mysql-server state=installed</span><br><span class="line">    - name: Calculate InnoDB buffer pool size</span><br><span class="line">    set_fact: innodb_buffer_pool_size_mb=&quot;&#123;&#123; ansible_memtotal_mb /2 &#125;&#125;&quot;</span><br><span class="line">    - name: Configure MySQL</span><br><span class="line">    template: src=templates/my.cnf.j2 dest=/etc/my.cnf owner=root group=root mode=0644</span><br><span class="line">    notify: restart mysql</span><br><span class="line">    - name: Start MySQL</span><br><span class="line">    service: name=mysqld state=started enabled=yes</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart mysql</span><br><span class="line">    service: name=mysqld state=restarted</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">symbolic-links=0</span><br><span class="line">innodb_buffer_pool_size = &#123;&#123; innodb_buffer_pool_size_mb|default(128) &#125;&#125;M</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br></pre></td></tr></table></figure>

<p>补充一个官方的例子</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Example setting host facts using key=value pairs</span></span><br><span class="line">- set_fact: one_fact=&quot;something&quot; other_fact=&quot;&#123;&#123; local_var * 2 &#125;&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Example setting host facts using complex arguments</span></span><br><span class="line">- set_fact:</span><br><span class="line">     one_fact: something</span><br><span class="line">     other_fact: &quot;&#123;&#123; local_var * 2 &#125;&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">As of 1.8, Ansible will convert boolean strings (<span class="string">&#x27;true&#x27;</span>, <span class="string">&#x27;false&#x27;</span>, <span class="string">&#x27;yes&#x27;</span>, <span class="string">&#x27;no&#x27;</span>)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">to proper boolean values when using the key=value syntax, however it is still</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">recommended that booleans be <span class="built_in">set</span> using the complex argument style:</span></span><br><span class="line">- set_fact:</span><br><span class="line">    one_fact: true</span><br><span class="line">    other_fact: false</span><br></pre></td></tr></table></figure>

<h4 id="pause"><a href="#pause" class="headerlink" title="pause"></a>pause</h4><p>暂停模块可以让我们在playbook中暂停一段时间，可以指定一个时间段，或者提示用户继续。在命令行模式中，这没什么用，但是在playbook中，这很有用处。<br>暂停模块通常被用在当我们需要用户来提供一个确认来继续的时候，或者在一个特殊的时间点手动确认。比如你更新一个web应用程序之后，你需要用户在接受用户的连接之前，手工确认一切Ok。这也可以用来提示用户一些可能出现的问题，并提供选项继续。Ansible会打印出服务器的名字，要求用户确认之后继续。如果在目标选项中设置了串行参数，Ansible会询问组里面的每一个主机。这种方式可以让用户在部署的时候，灵活的控制整个节奏，并监控整个交互过程。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- name: wait on user input</span><br><span class="line">  pause: prompt=&quot;Warning! Detected slight issue. ENTER to continue CTRL-C to quit.&quot;</span><br><span class="line"></span><br><span class="line">- name: timed wait</span><br><span class="line">  pause: seconds=30</span><br></pre></td></tr></table></figure>

<h4 id="wait-for"><a href="#wait-for" class="headerlink" title="wait_for"></a>wait_for</h4><p>wait_for模块用来检测一个tcp端口是否准备好接收远程连接，这是由远程主机来完成的。如果你只指定了端口，或者主机参数被设置为localhost，它会尝试连接远程受管主机。你可以用local_action参数来指定从控制机器来运行命令，并使用ansible_hostname做为主机参数来连接远程受管主机。这个模块在后台运行某些程序，或者启动某些进程需要一些时间的时候特别有用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- hosts: webapps</span><br><span class="line">  tasks:</span><br><span class="line">     - name: Install Tomcat</span><br><span class="line">       yum: name=tomcat6 state=installed</span><br><span class="line"></span><br><span class="line">     - name: Start Tomcat</span><br><span class="line">       service: name=tomcat6 state=started</span><br><span class="line"></span><br><span class="line">    - name: Wait for Tomcat to start</span><br><span class="line">      wait_for: port=8080 state=started</span><br></pre></td></tr></table></figure>

<h4 id="assemble"><a href="#assemble" class="headerlink" title="assemble"></a>assemble</h4><p>assemble组装模块把多个受管主机的文件合并成一个文件，当配置文件不允许包含的时候，这非常有用，特别是在设置root用户的authorized_keys文件的时候。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- hosts: all</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">     - name: Make a Directory in /opt</span><br><span class="line">       file: path=/opt/sshkeys state=directory owner=root group=root mode=0700</span><br><span class="line">     - name: Copy SSH keys over</span><br><span class="line">       copy: src=keys/&#123;&#123; item &#125;&#125;.pub dest=/opt/sshkeys/&#123;&#123; item &#125;&#125;.pub owner=root group=root mode=0600</span><br><span class="line">       with_items:</span><br><span class="line">          - dan</span><br><span class="line">          - kate</span><br><span class="line">          - mal</span><br><span class="line">    - name: Make the root users SSH config directory</span><br><span class="line">      file: path=/root/.ssh state=directory owner=root group=root mode=0700</span><br><span class="line">    - name: Build the authorized_keys file</span><br><span class="line">      assemble: src=/opt/sshkeys dest=/root/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>

<h4 id="add-host"><a href="#add-host" class="headerlink" title="add_host"></a>add_host</h4><p>add_host 添加主机模块是playbook中一个强大的模块，它可以让你动态的添加受管主机到一个play中。我们可以使用uri模块从CMDB中获得主机信息然后添加他们。它还可以将主机加到组里面，如果组不存在的话还会自动创建它。这个模块仅需要主机名和组名2个参数，跟主机库存清单的配置一样，我们还可以添加扩展的参数像ansible_ssh_user , ansible_ssh_port等等。</p>
<h4 id="group-by"><a href="#group-by" class="headerlink" title="group_by"></a>group_by</h4><p>group_by 模块可以让我们根据主机的真实特性来进行分组，真实特性可以通过add_fact来实现（前面已经介绍过set_fact）。group_by模块只接受一个参数，key，同样组名的机器就被分到一个组里面。如果我们在这里使用变量，我们就可以把同一个操作系统类型、同一个拓扑结构的、或者其他我们希望的拥有同样特性的主机分成一组，组可以在子play中、模板中的目标选项被使用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- name: Create operating system group</span><br><span class="line">  hosts: all</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - group_by: key=os_&#123;&#123; ansible_distribution &#125;&#125;</span><br><span class="line"></span><br><span class="line">    - name: Run on CentOS hosts only</span><br><span class="line">      hosts: os_CentOS</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Apache</span><br><span class="line">      yum: name=httpd state=latest</span><br><span class="line"></span><br><span class="line">    - name: Run on Ubuntu hosts only</span><br><span class="line">      hosts: os_Ubuntu</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Apache</span><br><span class="line">      apt: pkg=apache2 state=latest</span><br></pre></td></tr></table></figure>

<h4 id="get-url"><a href="#get-url" class="headerlink" title="get_url"></a>get_url</h4><p>将文件从HTTP，HTTPS或FTP下载到远程服务器。远程服务器必须能够直接访问远程资源。默认情况下，如果在目标主机上设置了环境变量<protocol> _proxy，那么请求将通过该代理发送。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- name: download foo.conf</span><br><span class="line">  get_url: url=http://example.com/path/file.conf dest=/etc/foo.conf mode=0440</span><br><span class="line"></span><br><span class="line">- name: download file with sha256 check</span><br><span class="line">  get_url: url=http://example.com/path/file.conf dest=/etc/foo.conf sha256sum=b5bb9d8014a0f9b1d61e21e796d78dccdf1352f23cd32812f4850b878ae4944c</span><br></pre></td></tr></table></figure>

<h4 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h4><p>该模块在执行期间打印语句，可用于调试变量或表达式，而无需停止操作手册。用于与’when：’指令一起调试。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Example that prints the loopback address and gateway <span class="keyword">for</span> each host</span></span><br><span class="line">- debug: msg=&quot;System &#123;&#123; inventory_hostname &#125;&#125; has uuid &#123;&#123; ansible_product_uuid &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">- debug: msg=&quot;System &#123;&#123; inventory_hostname &#125;&#125; has gateway &#123;&#123; ansible_default_ipv4.gateway &#125;&#125;&quot;</span><br><span class="line">  when: ansible_default_ipv4.gateway is defined</span><br><span class="line"></span><br><span class="line">- name: Display all variables/facts known for a host</span><br><span class="line">  debug: var=hostvars[inventory_hostname]</span><br><span class="line"></span><br><span class="line">  debug: msg=&quot;The varibale is  &#123;&#123; info[&#x27;stdout&#x27;]  &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>查看shell的输出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- name: check oenresty</span><br><span class="line">  shell: openresty -t</span><br><span class="line">  register: message</span><br><span class="line">- debug: var=message.stdout_lines</span><br><span class="line">- debug: var=message.stderr_lines</span><br></pre></td></tr></table></figure>

<h4 id="fail"><a href="#fail" class="headerlink" title="fail"></a>fail</h4><p>该模块无法通过自定义消息取得进展。当使用何时满足某个条件时，它可以用于救援。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Example playbook using fail and when together</span></span><br><span class="line">- fail: msg=&quot;The system may not be provisioned according to the CMDB status.&quot;</span><br><span class="line">  when: cmdb_status != &quot;to-be-staged&quot;</span><br></pre></td></tr></table></figure>

<h2 id="Handler-section"><a href="#Handler-section" class="headerlink" title="Handler section"></a>Handler section</h2><p>Handler 模块提供回调功能，在所有tasks任务执行完成后，才会执行Handler模块。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">   - name: template configuration file</span><br><span class="line">     template: src=template.j2 dest=/etc/foo.conf</span><br><span class="line">     notify:</span><br><span class="line">         - restart memcached</span><br><span class="line">         - restart apache</span><br><span class="line"></span><br><span class="line">handlers:</span><br><span class="line">    - name: restart memcached</span><br><span class="line">      service: name= memcached state=restarted</span><br><span class="line">    - name: restart apache</span><br><span class="line">      service: name=httpd state=restarted</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- hosts: all</span><br><span class="line">  user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: install memcached</span><br><span class="line">      yum: name=memcached state=installed</span><br><span class="line">    - name: set memcached size</span><br><span class="line">      set_fact: memcached_size=&quot;&#123;&#123; ansible_memtotal_mb /4 &#125;&#125;&quot;</span><br><span class="line">    - name: copy configurations</span><br><span class="line">      template: src=templates/memcached.j2 dest=/etc/sysconfig/memcached</span><br><span class="line">      notify:</span><br><span class="line">        - restart memcached</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart memcached</span><br><span class="line">      service: name=memcached state=restarted enabled=yes</span><br></pre></td></tr></table></figure>

<p>·Handlers只会在Play的末尾运行一次；如果想在一个Playbook的中间运行Handlers，则需要使用meta模块来实现，例如：-meta:flush_handlers。</p>
<p>·如果一个Play在运行到调用Handlers的语句之前失败了，那么这个Handlers将不会被执行。我们可以使用mega模块的–force-handlers选项来强制执行Handlers，即使是Handlers所在的Play中途运行失败也能执行。</p>
<h2 id="serial-参数的作用"><a href="#serial-参数的作用" class="headerlink" title="serial 参数的作用"></a>serial 参数的作用</h2><p>你可以定义Ansible可以在一个特定时间同时控制多少主机,使用<code>serial</code> 关键词:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- name: test play</span><br><span class="line">  hosts: webservers</span><br><span class="line">  serial: 3</span><br></pre></td></tr></table></figure>
<p>在上面的例子,如果我们有100台主机,3 台主机定义在组’webservers’ 可以在下面3个主机开始之前完全完成。</p>
<p>这个<code>serial</code>关键词在Ansible 1.8 以后可以被定义为百分数,用来定义每一次操作一个play中百分之多少主机:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- name: test play</span><br><span class="line">  hosts: websevers</span><br><span class="line">  serial: &quot;30%&quot;</span><br></pre></td></tr></table></figure>

<p>如果主机数不能被passes数量整除,最后的pass将会包含提醒信息。</p>
<h2 id="ansible-disable-swap"><a href="#ansible-disable-swap" class="headerlink" title="ansible disable swap"></a>ansible disable swap</h2><p><a target="_blank" rel="noopener" href="https://germaniumhq.com/2019/02/14/2019-02-14-Disabling-Swap-for-Kubernetes-in-an-Ansible-Playbook/">https://germaniumhq.com/2019/02/14/2019-02-14-Disabling-Swap-for-Kubernetes-in-an-Ansible-Playbook/</a></p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a target="_blank" rel="noopener" href="https://github.com/ansible/ansible-examples">ansible-examples</a><br><a target="_blank" rel="noopener" href="http://sapser.github.io/ansible/2014/07/21/ansible-playbook">ansible学习之四：Playbooks</a><br><a target="_blank" rel="noopener" href="https://galaxy.ansible.com/home">galaxy ansible 分享role配置文件的路径</a><br><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/2.4/ansible-playbook.html">ansible-playbook command tools</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2018/09/12/ansible-inventory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/09/12/ansible-inventory/" class="post-title-link" itemprop="url">ansible hosts及Inventory文件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-09-12 20:18:33" itemprop="dateCreated datePublished" datetime="2018-09-12T20:18:33+08:00">2018-09-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-10-10 11:24:24" itemprop="dateModified" datetime="2020-10-10T11:24:24+08:00">2020-10-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/ansible/" itemprop="url" rel="index"><span itemprop="name">ansible</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="主机目录配置文件"><a href="#主机目录配置文件" class="headerlink" title="主机目录配置文件"></a>主机目录配置文件</h2><ul>
<li>默认文件 : <code>/etc/ansible/hosts</code>。</li>
</ul>
<p>修改主机目录的配置文件: <code>/etc/ansible/ansible.cfg</code>, 指定inventory的路径</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inventory      = /data/db/playbook/inventory</span><br></pre></td></tr></table></figure>

<ul>
<li>命令行中传递主机目录配置文件。<code>ansible-playbook -i inventory site.yml</code> 或 <code>ansible-playbook --inventory-file inventory site.yml</code> 。</li>
</ul>
<h2 id="如何编写-Hosts-and-Groups（主机与组）"><a href="#如何编写-Hosts-and-Groups（主机与组）" class="headerlink" title="如何编写 Hosts and Groups（主机与组）"></a>如何编写 Hosts and Groups（主机与组）</h2><h3 id="简单的主机和组"><a href="#简单的主机和组" class="headerlink" title="简单的主机和组"></a>简单的主机和组</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mail.example.com</span><br><span class="line"></span><br><span class="line">[webservers]</span><br><span class="line">foo.example.com</span><br><span class="line">bar.example.com</span><br><span class="line"></span><br><span class="line">[dbservers]</span><br><span class="line">one.example.com</span><br><span class="line">two.example.com</span><br><span class="line">three.example.com</span><br></pre></td></tr></table></figure>

<ul>
<li>中括号中的名字代表组名，可以根据自己的需求将庞大的主机分成具有标识的组，如上面分了两个组webservers和dbservers组。</li>
<li>主机(hosts)部分可以使用域名、主机名、IP地址表示；当然使用前两者时，也需要主机能反解析到相应的IP地址，一般此类配置中多使用IP地址。</li>
</ul>
<h3 id="单独配置端口与别名"><a href="#单独配置端口与别名" class="headerlink" title="单独配置端口与别名"></a>单独配置端口与别名</h3><p>如果某些主机的SSH运行在自定义的端口上，ansible使用Paramiko进行ssh连接时，不会使用你SSH配置文件中列出的端口，但是如果修改ansible使用openssh进行ssh连接时将会使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">192.168.56.13:52113</span><br></pre></td></tr></table></figure>

<p>假如你想要为某些静态IP设置一些别名，可以这样做：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test1 ansible_ssh_port = 52113 ansible_ssh_host = 192.168.56.13</span><br></pre></td></tr></table></figure>

<p>上面的 test1别名就指代了IP为192.168.56.13，ssh连接端口为52113的主机。</p>
<h3 id="使用正则指定主机范围"><a href="#使用正则指定主机范围" class="headerlink" title="使用正则指定主机范围"></a>使用正则指定主机范围</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">www[01:50].example.com</span><br><span class="line"></span><br><span class="line">[databases]</span><br><span class="line">db-[a:f].example.com</span><br></pre></td></tr></table></figure>

<p>上面指定了从web1到web50，webservers组共计50台主机；databases组有db-a到db-f共6台主机。</p>
<h3 id="使用主机变量"><a href="#使用主机变量" class="headerlink" title="使用主机变量"></a>使用主机变量</h3><p>以下是Hosts部分中经常用到的变量部分：</p>
<ul>
<li><code>ansible_ssh_host</code>: #用于指定被管理的主机的真实IP。</li>
<li><code>ansible_ssh_port</code>: #用于指定连接到被管理主机的ssh端口号，默认是22。</li>
<li><code>ansible_ssh_user</code>: #ssh连接时默认使用的用户名。</li>
<li><code>ansible_ssh_pass</code>: #ssh连接时的密码。</li>
<li><code>ansible_sudo_pass</code>: #使用sudo连接用户时的密码。</li>
<li><code>ansible_sudo_exec</code>: #如果sudo命令不在默认路径，需要指定sudo命令路径。</li>
<li><code>ansible_ssh_private_key_file</code>: #秘钥文件路径，秘钥文件如果不想使用ssh-agent管理时可以使用此选项。</li>
<li><code>ansible_shell_type</code>: #目标系统的shell的类型，默认sh。</li>
<li><code>ansible_connection</code>: #SSH 连接的类型： local , ssh , paramiko，在 ansible 1.2 之前默认是 paramiko ，后来智能选择，优先使用基于 ControlPersist 的 ssh （支持的前提）。</li>
<li><code>ansible_python_interpreter</code>: #用来指定python解释器的路径，默认为&#x2F;usr&#x2F;bin&#x2F;python 同样可以指定ruby 、perl 的路径。</li>
<li><code>ansible_*_interpreter</code>: #其他解释器路径，用法与ansible_python_interpreter类似，这里”*”可以是ruby或才perl等其他语言。</li>
</ul>
<p>示例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[test]</span><br><span class="line">192.168.1.1 ansible_ssh_user=root ansible_ssh_pass=&#x27;abcdefg&#x27;</span><br><span class="line">192.168.1.2 ansible_ssh_user=breeze ansible_ssh_pass=&#x27;123456&#x27;</span><br><span class="line">192.168.1.3 ansible_ssh_user=bernie ansible_ssh_port=3055 ansible_ssh_pass=&#x27;456789&#x27;</span><br></pre></td></tr></table></figure>

<p>上面的示例中指定了三台主机，三台主机的用密码分别是abcdefg、123456、45789，指定的ssh连接的用户名分别为root、breeze、bernie，ssh 端口分别为22、22、3055 ，这样在ansible命令执行的时候就不用再指令用户和密码等了。</p>
<h3 id="组内变量"><a href="#组内变量" class="headerlink" title="组内变量"></a>组内变量</h3><p>变量也可以通过组名，应用到组内的所有成员：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[webserver]</span><br><span class="line">host1</span><br><span class="line">host2</span><br><span class="line"></span><br><span class="line">[webserver:vars]</span><br><span class="line">ntp_server=ntp.atlanta.example.com</span><br><span class="line">proxy=proxy.atlanta.example.com</span><br></pre></td></tr></table></figure>

<p>上面test组中包含两台主机，通过对test组指定vars变更，相应的host1和host2相当于相应的指定了ntp_server和proxy变量参数值 。</p>
<h3 id="按目录结构存储变量"><a href="#按目录结构存储变量" class="headerlink" title="按目录结构存储变量"></a>按目录结构存储变量</h3><p>假设inventory文件为&#x2F;etc&#x2F;ansible&#x2F;hosts，那么相关的hosts和group变量可以放在下面的目录结构下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/ansible/group_vars/webserver # can optionally end in &#x27;.yml&#x27;, &#x27;.yaml&#x27;, or &#x27;.json&#x27;</span><br><span class="line">/etc/ansible/group_vars/webservers</span><br><span class="line">/etc/ansible/host_vars/foosball</span><br></pre></td></tr></table></figure>

<p><code>/etc/ansible/group_vars/webserver</code>文件内容可以为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">ntp_server: acme.example.org</span><br><span class="line">database_server: storage.example.org</span><br></pre></td></tr></table></figure>

<p>如果对应的名字为目录名，ansible会读取这个目录下面所有文件的内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/ansible/group_vars/raleigh/db_settings</span><br><span class="line">/etc/ansible/group_vars/raleigh/cluster_settings</span><br></pre></td></tr></table></figure>

<p>group_vars&#x2F; 和 host_vars&#x2F; 目录可放在 inventory 目录下,或是 playbook 目录下. 如果两个目录下都存在,那么 playbook 目录下的配置会覆盖 inventory 目录的配置.</p>
<h3 id="组的包含与组内变量"><a href="#组的包含与组内变量" class="headerlink" title="组的包含与组内变量"></a>组的包含与组内变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[atlanta]</span><br><span class="line">host1</span><br><span class="line">host2</span><br><span class="line"></span><br><span class="line">[raleigh]</span><br><span class="line">host2</span><br><span class="line">host3</span><br><span class="line"></span><br><span class="line">[southeast:children]</span><br><span class="line">atlanta</span><br><span class="line">raleigh</span><br><span class="line"></span><br><span class="line">[southeast:vars]</span><br><span class="line">some_server=foo.southeast.example.com</span><br><span class="line">halon_system_timeout=30</span><br><span class="line">self_destruct_countdown=60</span><br><span class="line">escape_pods=2</span><br><span class="line"></span><br><span class="line">[usa:children]</span><br><span class="line">southeast</span><br><span class="line">northeast</span><br><span class="line">southwest</span><br><span class="line">northwest</span><br></pre></td></tr></table></figure>

<ul>
<li>任何属于子组的成员都自动成为父组的成员。</li>
<li>子组的变量将具有更高的优先级（覆盖）父组的变量。</li>
<li>组可以有多个父母和孩子，但不是循环关系。</li>
<li>主机也可以在多个组中，但只有一个主机实例，合并来自多个组的数据。</li>
</ul>
<p>注：vars变量在ansible ad-hoc部分中基本用不到，主要用在ansible-playbook中。</p>
<h2 id="Patterns（主机与组正则匹配部分）"><a href="#Patterns（主机与组正则匹配部分）" class="headerlink" title="Patterns（主机与组正则匹配部分）"></a>Patterns（主机与组正则匹配部分）</h2><p>把Patterns 直接理解为正则实际是不完全准确的，正常的理解为patterns意味着在ansible中管理哪些主机，也可以理解为，要与哪台主机进行通信。在探讨这个问题之前我们先看下ansible的用法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible &lt;pattern_goes_here&gt; -m &lt;module_name&gt; -a &lt;arguments&gt;</span><br></pre></td></tr></table></figure>

<p>直接上一个示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible webservers -m service -a &quot;name=httpd state=restarted&quot;</span><br></pre></td></tr></table></figure>

<p>这里是对webservers 组或主机重启httpd服务 ，其中webservers 就是Pattern部分。而之所以上面说Pattern（模式）可以理解为正则，主要针对下面经常用到的用法而言的。</p>
<ol>
<li>表示所有的主机可以使用all 或 *</li>
<li>通配符与逻辑或</li>
<li>利用通配符还可以指定一组具有规则特征的主机或主机名，冒号表示or－－－逻辑或</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">web1.biglittleant.com</span><br><span class="line">web1.biglittleant.com:web2.biglittleant.com</span><br><span class="line">192.168.1.1</span><br><span class="line">192.168.1.*</span><br></pre></td></tr></table></figure>

<p>当然，这里的*通配符也可以用在前面，如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*.biglittleant.com</span><br><span class="line">*.com</span><br><span class="line">webservers1[0]     #表示匹配 webservers1 组的第 1 个主机</span><br><span class="line">webservers1[0:25]  #表示匹配 webservers1 组的第 1 个到第 25 个主机（官网文档是&quot;:&quot;表示范围，测试发现应该使用&quot;-&quot;,注意不要和匹配多个主机组混淆）</span><br></pre></td></tr></table></figure>

<p>上面的用法，在多个组之间同样适用 ，如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">webservers</span><br><span class="line">webservers:dbservers  #表示两个组中所有的主机</span><br></pre></td></tr></table></figure>

<h3 id="逻辑非与逻辑and"><a href="#逻辑非与逻辑and" class="headerlink" title="逻辑非与逻辑and"></a>逻辑非与逻辑and</h3><p>非的表达式，如，目标主机必须在组webservers但不在phoenix组中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webserver:!phoenix</span><br></pre></td></tr></table></figure>

<p>交集的表达式，如，目标主机必须即在组webservers中又在组staging中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webservers:&amp;staging</span><br></pre></td></tr></table></figure>

<p>一个更复杂的示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webserver:dbservers:&amp;staging:!phoenix</span><br></pre></td></tr></table></figure>

<p>上面这个复杂的表达式最后表示的目标主机必须满足：在webservers或者dbservers组中，必须还存在于staging组中，但是不在phoenix组中 。</p>
<h3 id="混合高级用法"><a href="#混合高级用法" class="headerlink" title="混合高级用法"></a>混合高级用法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*.yanruogu.com:*.org</span><br></pre></td></tr></table></figure>
<p>还可以在开头的地方使用”~”，用来表示这是一个正则表达式:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~(web|db).*\.yanruogu\.com</span><br></pre></td></tr></table></figure>

<p>给两个ansible-playbook中具体可能用的用法：</p>
<ol>
<li>在ansible-palybook命令中，你也可以使用变量来组成这样的表达式，但是你必须使用“-e”的选项来指定这个表达式（通常我们不这样用）：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-palybook -e webservers:!`excluded`:&amp;`required`</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在ansible和ansible-playbook中，还可以通过一个参数”–limit”来明确指定排除某些主机或组：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook site.yml --limit datacenter2</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>从Ansible1.2开始，如果想排除一个文件中的主机可以使用”@”：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook site.yml --limit @retry_hosts.txt</span><br></pre></td></tr></table></figure>

<h2 id="动态-定义主机组"><a href="#动态-定义主机组" class="headerlink" title="动态 定义主机组"></a>动态 定义主机组</h2><h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i inventory/ other -m ping</span><br></pre></td></tr></table></figure>

<p>当执行如上命令时，other 如果有多个组，他会将所有的other组都执行。而不是报错。</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a target="_blank" rel="noopener" href="http://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#hosts-and-groups">Working with Inventory</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2018/09/10/ansible-install/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/09/10/ansible-install/" class="post-title-link" itemprop="url">ansible 入门安装及配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-09-10 20:18:33" itemprop="dateCreated datePublished" datetime="2018-09-10T20:18:33+08:00">2018-09-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-10-10 11:24:19" itemprop="dateModified" datetime="2020-10-10T11:24:19+08:00">2020-10-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/ansible/" itemprop="url" rel="index"><span itemprop="name">ansible</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ansible-简介"><a href="#ansible-简介" class="headerlink" title="ansible 简介"></a>ansible 简介</h2><h3 id="ansible整体软件架构图"><a href="#ansible整体软件架构图" class="headerlink" title="ansible整体软件架构图"></a>ansible整体软件架构图</h3><p>Ansible 在管理节点将 Ansible 模块通过 SSH 协议（或者 Kerberos、LDAP）推送到被管理端执行，执行完之后自动删除，可以使用 SVN 等来管理自定义模块及编排</p>
<p><img src="/media/ansible-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="ansible-整体架构图"></p>
<ol>
<li>管理端支持local 、ssh、zeromq 三种方式连接被管理端，默认使用基于ssh的连接。</li>
<li>可以按应用类型等方式进行Host Inventory（主机群）分类，管理节点通过各类模块实现相应的操作。单个模块，单条命令的批量执行，我们可以称之为ad-hoc；</li>
<li>管理节点可以通过playbooks 实现多个task的集合实现一类功能，如web服务的安装部署、数据库服务器的批量备份等。playbooks我们可以简单的理解为，系统通过组合多条ad-hoc操作的配置文件。</li>
</ol>
<h3 id="ansible-软件基本架构"><a href="#ansible-软件基本架构" class="headerlink" title="ansible 软件基本架构"></a>ansible 软件基本架构</h3><p><img src="/media/ansible-%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="ansible-软件架构图"></p>
<p>远程调用管理模块，从Inventory里调用主机名字, ssh远端服务器执行命令，执行完成返回结果。</p>
<h3 id="ansible特性"><a href="#ansible特性" class="headerlink" title="ansible特性"></a>ansible特性</h3><ol>
<li><p>基于python语言实现， 模块化设计 ，调用特定的模块来完成特定任务 ，本身是核心组件，短小精悍 。</p>
</li>
<li><p>由Paramiko来实现创建ssh连接，基于ssh协议连接每一个被管理主机。</p>
</li>
<li><p>YAML格式是基于PyYAML模块来实现功能的，因为这个模块还支持模板语言，所以还需要jinjia2模板语言。</p>
</li>
<li><p>由Paramiko，PyYAML和Jinjia2三个关键模块。</p>
</li>
<li><p>no agents：部署简单，不需要在被管控主机上安装任何客户端；</p>
</li>
<li><p>no server：无服务器端，使用时直接运行命令即可；</p>
</li>
<li><p>modules in any languages：支持自定义模块，基于“模块”完成各种“任务”，支持各种可使用任意语言开发模块；</p>
</li>
<li><p>yaml，not code：使用yaml语言定制剧本playbook；</p>
</li>
<li><p>ssh by default：，使用SSH协议并基于SSH工作（基于密钥认证或在inventory文件中指定账号和密码）；</p>
</li>
<li><p>strong multi-tier solution：可实现多级指挥。</p>
</li>
</ol>
<h3 id="ansible的任务执行流程"><a href="#ansible的任务执行流程" class="headerlink" title="ansible的任务执行流程"></a>ansible的任务执行流程</h3><ol>
<li>读取配置。</li>
<li>抓取全量机器&amp;分组列表 – 可从多个静态文件、文件夹、脚本中读取机器，分组及其变关联量信息。</li>
<li>使用host-pattern过滤机器列表。</li>
<li>根据参数确定执行模块和配置–从modules目录动态读取，用户可以自行开发模块。</li>
<li>Runner执行返回。<ul>
<li>Connection环节定义连接方式 &#x3D;&gt; Action阶段机器列表（Lookup plugin Action变量&#x2F;文件等资源的获取）。</li>
<li>Callback plugin各阶段的钩子调用。</li>
</ul>
</li>
<li>输出结束。<ul>
<li>Filter plugin过滤算子。</li>
<li>Callback plugin各阶段的钩子调用。</li>
</ul>
</li>
</ol>
<h2 id="实战安装ansible"><a href="#实战安装ansible" class="headerlink" title="实战安装ansible"></a>实战安装ansible</h2><p>master端 配置免密钥登录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t dsa  ## 生成密钥</span><br><span class="line">ls .ssh/</span><br><span class="line">authorized_keys  id_dsa  id_dsa.pub</span><br></pre></td></tr></table></figure>

<p>拷贝<code>id_dsa.pub</code>文件到远程主机的authorized_keys中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -P 52113 niu@192.168.56.13:~</span><br></pre></td></tr></table></figure>

<p>在slave端配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir .ssh</span><br><span class="line">mv id_dsa.pub .ssh/</span><br><span class="line">cd .ssh/</span><br><span class="line">cat id_dsa.pub &gt;&gt; authorized_keys</span><br><span class="line">chmod 600 authorized_keys</span><br><span class="line">chmod 700 ~/.ssh</span><br></pre></td></tr></table></figure>

<p>测试本机是否可以正常执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 52113 niu@192.168.56.13</span><br><span class="line">Last login: Mon Jun  4 14:50:09 2018 from 192.168.56.12</span><br><span class="line">[niu@linux-node3 ~18:14:49]$</span><br></pre></td></tr></table></figure>

<p>开始安装ansible服务器端，需要配置epel源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">yum install ansible -y</span><br></pre></td></tr></table></figure>

<p>开始编辑hosts文件，默认存放在<code>/etc/ansible</code>目录中 <code>vim /etc/ansible/hosts</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[test]</span><br><span class="line">192.168.56.13</span><br><span class="line">[test:vars]</span><br><span class="line">ansible_ssh_user=&quot;niu&quot;</span><br><span class="line">ansible_ssh_port=52113</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由于我修改了ssh端口，并禁止了root登录，所以我们需要定义登录用户，及ssh端口号。</p>
</blockquote>
<p>测试主机是否能够ping通。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> ansible test -m ping</span><br><span class="line">192.168.56.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编写配置文件"><a href="#编写配置文件" class="headerlink" title="编写配置文件"></a>编写配置文件</h2><p>ansible config文件查找路径</p>
<p>ANSIBLE_CONFIG (环境变量中的设置)<br>ansible.cfg (当前目录下的ansiblee.cfg)<br>~&#x2F;.ansible.cfg (家目录下)<br>&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg (全局目录)</p>
<p>常用配置参数</p>
<ul>
<li>transport 默认参数：smart，可选参数 ssh,paramiko ,如果使用smart ansible则会自动选择。</li>
<li>remote_user 设置目标计算机的登录用户。如果为空白，它将使用连接插件的默认值，通常是当前正在执行Ansible的用户。</li>
<li>remote_port 在远程连接中使用的端口，空白时将使用默认的连接插件。</li>
<li>forks 连接远程主机的时候最大开启进程数。</li>
<li>stdout_callback 设置默认回调是使用的stdout</li>
<li>jinja2_extensions jinja2的扩展参数</li>
<li>library 自定义扩展模块地址</li>
<li>roles_path ansible role文件的搜索路径使用:隔开。默认配置 ~&#x2F;.ansible&#x2F;roles:&#x2F;usr&#x2F;share&#x2F;ansible&#x2F;roles:&#x2F;etc&#x2F;ansible&#x2F;roles</li>
</ul>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a target="_blank" rel="noopener" href="http://docs.ansible.com/ansible/latest/index.html">ansible 官方文档</a><br><a target="_blank" rel="noopener" href="http://getansible.com/begin/play_vs_playbook">Ansible入门</a><br><a target="_blank" rel="noopener" href="http://ansible-tran.readthedocs.io/en/latest/index.html">Ansible中文权威指南</a><br><a target="_blank" rel="noopener" href="http://blog.51cto.com/breezey/1555530">Ansible5：常用模块</a><br><a target="_blank" rel="noopener" href="https://www.kancloud.cn/shusheng/ansiblebook/235863#53_playbook_409">ansible超详细使用指南</a><br><a target="_blank" rel="noopener" href="https://frank6866.gitbooks.io/ansible/content/chapters/tricks/ansible-tricks-file-existed.html">ansible实践</a><br><a target="_blank" rel="noopener" href="https://ansible-book.gitbooks.io/ansible-first-book/advance/playbook/tiao_jian_xuan_ze.html">ansible-first-book</a></p>
<h2 id="报错汇总"><a href="#报错汇总" class="headerlink" title="报错汇总"></a>报错汇总</h2><p>报错一：提示sudo命令将要被停止。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[DEPRECATION WARNING]: The sudo command line option has been deprecated in favor of the &quot;become&quot; command line arguments. This</span><br><span class="line">feature will be removed in version 2.6. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node2 ~14:12:01]#ansible -s test -m file -a &#x27;path=/tmp/test-niu state=touch&#x27;</span><br><span class="line">192.168.56.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/test-niu&quot;,</span><br><span class="line">    &quot;gid&quot;: 0,</span><br><span class="line">    &quot;group&quot;: &quot;root&quot;,</span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;,</span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;,</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;state&quot;: &quot;file&quot;,</span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解决办法: -s 替换成–become</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ansible test -m file -a &#x27;path=/data/app/1.txt state=touch&#x27; --become</span><br><span class="line">192.168.56.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;dest&quot;: &quot;/data/app/1.txt&quot;,</span><br><span class="line">    &quot;gid&quot;: 0,</span><br><span class="line">    &quot;group&quot;: &quot;root&quot;,</span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;,</span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;,</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;state&quot;: &quot;file&quot;,</span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="格式错误"><a href="#格式错误" class="headerlink" title="格式错误"></a>格式错误</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal: [linux-node2]: FAILED! =&gt; &#123;&quot;changed&quot;: false, &quot;checksum&quot;: &quot;823af87241d8f906a4c23d6e0f90aebf9620ccc3&quot;, &quot;msg&quot;: &quot;Unsupported parameters for (copy) module: user Supported parameters include: attributes, backup, checksum, content, delimiter, dest, directory_mode, follow, force, group, local_follow, mode, original_basename, owner, regexp, remote_src, selevel, serole, setype, seuser, src, unsafe_writes, validate&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>原始文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: config dns server</span><br><span class="line">  template: src=resolv.conf dest=/etc/resolv.conf mode=644 user=root group=root</span><br></pre></td></tr></table></figure>

<p>解决办法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: config dns server</span><br><span class="line">  template: src=resolv.conf dest=/etc/resolv.conf mode=644 owner=root group=root</span><br></pre></td></tr></table></figure>


<h3 id="执行提示字符编码不对"><a href="#执行提示字符编码不对" class="headerlink" title="执行提示字符编码不对"></a>执行提示字符编码不对</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR! Unexpected Exception, this is probably a bug: &#x27;ascii&#x27; codec can&#x27;t decode byte 0xe6 in position 8: ordinal not in range(128)</span><br></pre></td></tr></table></figure>

<p>因为inventory 里面编写了一个中文的md文档，导致的报错。<br>将中文文档移除，问题解决。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2017/02/26/pstree-%E7%9B%AE%E5%BD%95%E6%A0%91%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/02/26/pstree-%E7%9B%AE%E5%BD%95%E6%A0%91%E5%8A%9F%E8%83%BD/" class="post-title-link" itemprop="url">pstree 命令更优雅的树状显示</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-02-26 19:53:01" itemprop="dateCreated datePublished" datetime="2017-02-26T19:53:01+08:00">2017-02-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-09-18 18:18:43" itemprop="dateModified" datetime="2020-09-18T18:18:43+08:00">2020-09-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="pstree-命令更优雅的树状显示"><a href="#pstree-命令更优雅的树状显示" class="headerlink" title="pstree 命令更优雅的树状显示"></a>pstree 命令更优雅的树状显示</h1><p>Linux pstree命令将所有行程以树状图显示，树状图将会以 pid (如果有指定) 或是以 init 这个基本行程为根 (root)，如果有指定使用者 id，则树状图会只显示该使用者所拥有的行程。</p>
<p>在Linux系统中，系统调用fork可以创建子进程，通过子shell也可以创建子进程，Linux系统中进程之间的关系天生就是一棵树，树的根就是进程PID为1的init进程。</p>
<h2 id="命令参数"><a href="#命令参数" class="headerlink" title="命令参数"></a>命令参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pstree: unrecognized option &#x27;--help&#x27;</span><br><span class="line">Usage: pstree [ -a ] [ -c ] [ -h | -H PID ] [ -l ] [ -n ] [ -p ] [ -g ] [ -u ]</span><br><span class="line">              [ -A | -G | -U ] [ PID | USER ]</span><br><span class="line">       pstree -V</span><br><span class="line">Display a tree of processes.</span><br><span class="line"></span><br><span class="line">  -a, --arguments     显示命令参数</span><br><span class="line">  -A, --ascii         使用 ASCII 画线</span><br><span class="line">  -c, --compact       不压缩相同的子进程</span><br><span class="line">  -h, --highlight-all 高亮现在执行的程序</span><br><span class="line">  -H PID, --highlight-pid=PID 高亮指定的程序</span><br><span class="line">  -g, --show-pgids    显示进程组ID; implies -c</span><br><span class="line">  -G, --vt100         使用 VT100 画线</span><br><span class="line">  -l, --long          不截断长的行</span><br><span class="line">  -n, --numeric-sort  按照pid进行排序</span><br><span class="line">  -N type,</span><br><span class="line">  --ns-sort=type      用程序识别码排序(ipc, mnt, net, pid, user, uts)。预设是以程序名称来排序；</span><br><span class="line">  -p, --show-pids     显示pid; implies -c</span><br><span class="line">  -s, --show-parents  显示进程的父ID</span><br><span class="line">  -S, --ns-changes    显示 namespace 信息</span><br><span class="line">  -u, --uid-changes   显示 用户 名称</span><br><span class="line">  -U, --unicode       使用 UTF-8 (Unicode) 画线</span><br><span class="line">  -V, --version       显示版本</span><br><span class="line">  -Z,</span><br><span class="line">  --security-context   显示 SELinux 内容</span><br><span class="line">  PID    start at this PID; default is 1 (init)</span><br><span class="line">  USER   show only trees rooted at processes of this user</span><br></pre></td></tr></table></figure>

<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>以树状图只显示进程的名字，且相同进程合并显示： pstree</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# pstree</span><br><span class="line">systemd─┬─NetworkManager─┬─dhclient</span><br><span class="line">        │                └─2*[&#123;NetworkManager&#125;]</span><br><span class="line">        ├─VBoxService───8*[&#123;VBoxService&#125;]</span><br><span class="line">        ├─agetty</span><br><span class="line">        ├─auditd───&#123;auditd&#125;</span><br><span class="line">        ├─chronyd</span><br><span class="line">        ├─containerd───10*[&#123;containerd&#125;]</span><br><span class="line">        ├─crond</span><br><span class="line">        ├─dbus-daemon</span><br><span class="line">        ├─gssproxy───5*[&#123;gssproxy&#125;]</span><br><span class="line">        ├─irqbalance</span><br><span class="line">        ├─keepalived───2*[keepalived]</span><br><span class="line">        ├─kube-apiserver───8*[&#123;kube-apiserver&#125;]</span><br><span class="line">        ├─kube-controller───7*[&#123;kube-controller&#125;]</span><br><span class="line">        ├─kube-proxy───7*[&#123;kube-proxy&#125;]</span><br><span class="line">        ├─kube-scheduler───9*[&#123;kube-scheduler&#125;]</span><br><span class="line">        ├─kubelet───13*[&#123;kubelet&#125;]</span><br><span class="line">        ├─polkitd───6*[&#123;polkitd&#125;]</span><br><span class="line">        ├─rpc.statd</span><br><span class="line">        ├─rpcbind</span><br><span class="line">        ├─rsyslogd───2*[&#123;rsyslogd&#125;]</span><br><span class="line">        ├─sshd───sshd───sshd───bash───sudo───su───bash───pstree</span><br><span class="line">        ├─supervisord───etcd───7*[&#123;etcd&#125;]</span><br><span class="line">        ├─systemd-journal</span><br><span class="line">        ├─systemd-logind</span><br><span class="line">        ├─systemd-udevd</span><br><span class="line">        └─tuned───4*[&#123;tuned&#125;]</span><br></pre></td></tr></table></figure>

<p>以树状图显示进程同时还显示PID：pstree -p</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# pstree -p</span><br><span class="line">systemd(1)─┬─NetworkManager(2494)─┬─dhclient(2530)</span><br><span class="line">           │                      ├─&#123;NetworkManager&#125;(2509)</span><br><span class="line">           │                      └─&#123;NetworkManager&#125;(2512)</span><br><span class="line">           ├─VBoxService(2316)─┬─&#123;VBoxService&#125;(2318)</span><br><span class="line">           │                   ├─&#123;VBoxService&#125;(2319)</span><br><span class="line">           │                   ├─&#123;VBoxService&#125;(2320)</span><br><span class="line">           │                   ├─&#123;VBoxService&#125;(2321)</span><br><span class="line">           │                   ├─&#123;VBoxService&#125;(2322)</span><br><span class="line">           │                   ├─&#123;VBoxService&#125;(2326)</span><br><span class="line">           │                   ├─&#123;VBoxService&#125;(2327)</span><br><span class="line">           │                   └─&#123;VBoxService&#125;(2328)</span><br><span class="line">           ├─agetty(506)</span><br><span class="line">           ├─auditd(414)───&#123;auditd&#125;(415)</span><br><span class="line">           ├─chronyd(455)</span><br><span class="line">           ├─containerd(910)─┬─&#123;containerd&#125;(943)</span><br><span class="line">           │                 ├─&#123;containerd&#125;(944)</span><br><span class="line">           │                 ├─&#123;containerd&#125;(945)</span><br><span class="line">           │                 ├─&#123;containerd&#125;(946)</span><br><span class="line">           │                 ├─&#123;containerd&#125;(987)</span><br><span class="line">           │                 ├─&#123;containerd&#125;(1017)</span><br><span class="line">           │                 ├─&#123;containerd&#125;(1034)</span><br><span class="line">           │                 ├─&#123;containerd&#125;(1150)</span><br><span class="line">           │                 ├─&#123;containerd&#125;(1151)</span><br><span class="line">           │                 └─&#123;containerd&#125;(1312)</span><br><span class="line">           ├─crond(505)</span><br><span class="line">           ├─dbus-daemon(452)</span><br><span class="line">... 省略部分结果</span><br></pre></td></tr></table></figure>

<p>以树状图显示进程PID为的进程以及子孙进程，如果有-p参数则同时显示每个进程的PID：pstree [-p] <pid></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# pstree -p 918</span><br><span class="line">etcd(918)─┬─&#123;etcd&#125;(930)</span><br><span class="line">          ├─&#123;etcd&#125;(931)</span><br><span class="line">          ├─&#123;etcd&#125;(932)</span><br><span class="line">          ├─&#123;etcd&#125;(948)</span><br><span class="line">          ├─&#123;etcd&#125;(952)</span><br><span class="line">          ├─&#123;etcd&#125;(1057)</span><br><span class="line">          └─&#123;etcd&#125;(1072)</span><br></pre></td></tr></table></figure>

<p>以树状图显示进程，相同名称的进程不合并显示，并且会显示命令行参数，如果有-p参数则同时显示每个进程的PID。pstree -a</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pstree -a -p 910</span><br><span class="line">containerd,910 --config /data/apps/containerd/containerd-config.toml</span><br><span class="line">  ├─&#123;containerd&#125;,943</span><br><span class="line">  ├─&#123;containerd&#125;,944</span><br><span class="line">  ├─&#123;containerd&#125;,945</span><br><span class="line">  ├─&#123;containerd&#125;,946</span><br><span class="line">  ├─&#123;containerd&#125;,987</span><br><span class="line">  ├─&#123;containerd&#125;,1017</span><br><span class="line">  ├─&#123;containerd&#125;,1034</span><br><span class="line">  ├─&#123;containerd&#125;,1150</span><br><span class="line">  ├─&#123;containerd&#125;,1151</span><br><span class="line">  └─&#123;containerd&#125;,1312</span><br><span class="line">...省略部分结果</span><br></pre></td></tr></table></figure>

<p>注：因为pstree输出的信息可能比较多，所以最好与more&#x2F;less配合使用,使用上下箭头查看，按q退出。pstree -p | less</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a target="_blank" rel="noopener" href="https://man.linuxde.net/pstree">pstree命令</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/huchong/p/10065246.html">linux每日命令(34)：ps命令和pstree命令</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2017/01/13/linux-install-config/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/01/13/linux-install-config/" class="post-title-link" itemprop="url">linux系统初始化配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-01-13 20:11:23" itemprop="dateCreated datePublished" datetime="2017-01-13T20:11:23+08:00">2017-01-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-09-16 17:33:13" itemprop="dateModified" datetime="2020-09-16T17:33:13+08:00">2020-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="更新yum源"><a href="#更新yum源" class="headerlink" title="更新yum源"></a>更新yum源</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo&amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;set aliyun OK .....&quot;</span> ||<span class="built_in">echo</span> <span class="string">&quot;yum update error .....&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="安装基础软件"><a href="#安装基础软件" class="headerlink" title="安装基础软件"></a>安装基础软件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y tree nmap sysstat lrzsz dos2unix wget vim lsof ntpdate iotop iftop screen zabbix-agent salt-minion</span><br></pre></td></tr></table></figure>


<h3 id="优化开机启动项"><a href="#优化开机启动项" class="headerlink" title="优化开机启动项"></a>优化开机启动项</h3><p>centos6 优化开机启动项</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --list |grep 3:on |awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> |egrep -v <span class="string">&quot;sshd|network|crond|rsyslog&quot;</span>|sed -rn <span class="string">&#x27;s#(.*)#chkconfig \1 off#gp&#x27;</span>|bash</span><br></pre></td></tr></table></figure>

<p>centos7 优化开机启动项</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files |grep enabled |awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> |egrep -v <span class="string">&quot;sshd.service|rsyslog.service|crond.service&quot;</span>| sed -rn <span class="string">&#x27;s#(.*)#systemctl disable \1 #gp&#x27;</span> |bash</span><br><span class="line"><span class="comment"># 如果使用rc.local 需要坚持rc-local启动项</span></span><br><span class="line">systemctl list-unit-files |grep rc-local.service</span><br></pre></td></tr></table></figure>

<h3 id="关闭selinux配置"><a href="#关闭selinux配置" class="headerlink" title="关闭selinux配置"></a>关闭selinux配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /etc/selinux/config /etc/selinux/config.bak</span><br><span class="line">sed <span class="string">&#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27;</span> /etc/selinux/config.bak &gt;/etc/selinux/config</span><br></pre></td></tr></table></figure>

<h3 id="优化SSH配置"><a href="#优化SSH配置" class="headerlink" title="优化SSH配置"></a>优化SSH配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s/GSSAPIAuthentication yes/#GSSAPIAuthentication yes/g&#x27;</span> /etc/ssh/ssh_config</span><br><span class="line">sed  -i <span class="string">&quot;s/Port 22/#Port 22/g&quot;</span> /etc/ssh/sshd_config</span><br><span class="line"><span class="built_in">cat</span> &gt;&gt;/etc/ssh/sshd_config&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">Port 52113</span></span><br><span class="line"><span class="string">PermitRootLogin no</span></span><br><span class="line"><span class="string">PermitEmptyPasswords no</span></span><br><span class="line"><span class="string">UseDNS no</span></span><br><span class="line"><span class="string">GSSAPIAuthentication no</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改SSH的默认端口。</li>
<li>禁止root登录。</li>
<li>优化SSH连接速度。</li>
</ul>
<h3 id="配置普通用户登录"><a href="#配置普通用户登录" class="headerlink" title="配置普通用户登录"></a>配置普通用户登录</h3><p>创建普通用户，并加入到sudo中。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span> niu || useradd niu</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;123456&quot;</span> |passwd niu --stdin</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;niu        ALL=(ALL)       ALL&quot;</span> &gt;&gt;/etc/sudoers</span><br></pre></td></tr></table></figure>

<h3 id="配置时间更新"><a href="#配置时间更新" class="headerlink" title="配置时间更新"></a>配置时间更新</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;&gt;/var/spool/cron/root&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">time sync by niu  at 2010-2-1</span></span><br><span class="line"><span class="string">*/10 * * * * /usr/sbin/ntpdate pool.ntp.org &gt;/dev/null 2&gt;&amp;1</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>


<h3 id="修改文件描述符"><a href="#修改文件描述符" class="headerlink" title="修改文件描述符"></a>修改文件描述符</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;*  -  nofile  65535&#x27;</span> &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure>

<h3 id="关闭登录显示服务器信息"><a href="#关闭登录显示服务器信息" class="headerlink" title="关闭登录显示服务器信息"></a>关闭登录显示服务器信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## close Login Information</span></span><br><span class="line">&gt; /etc/issue</span><br><span class="line">&gt; /etc/issue.net</span><br></pre></td></tr></table></figure>

<h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><p>关闭centos6的防火墙</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/iptables stop</span><br><span class="line">chkconfig iptables off</span><br></pre></td></tr></table></figure>


<p>关闭centos7的防火墙</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure>


<h2 id="补充知识"><a href="#补充知识" class="headerlink" title="补充知识"></a>补充知识</h2><h3 id="vmware克隆虚拟机后网卡无法启动问题"><a href="#vmware克隆虚拟机后网卡无法启动问题" class="headerlink" title="vmware克隆虚拟机后网卡无法启动问题"></a>vmware克隆虚拟机后网卡无法启动问题</h3><p>第一步：修改克隆后虚拟机的网卡mac地址<br>第二步：执行如下脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line">sed -i <span class="string">&#x27;/UUID/d&#x27;</span> /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line">sed -i <span class="string">&#x27;/HWADDR/d&#x27;</span> /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line">&gt;/etc/udev/rules.d/70-persistent-net.rules</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2017/01/12/ssh-get-key/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/01/12/ssh-get-key/" class="post-title-link" itemprop="url">ssh-免密钥登录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-01-12 20:06:32" itemprop="dateCreated datePublished" datetime="2017-01-12T20:06:32+08:00">2017-01-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-09-18 18:23:20" itemprop="dateModified" datetime="2020-09-18T18:23:20+08:00">2020-09-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="制作密钥对"><a href="#制作密钥对" class="headerlink" title="制作密钥对"></a>制作密钥对</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh-keygen -t dsa  ##创建密钥对使用dsa加密</span></span><br><span class="line">Generating public/private dsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/niu/.ssh/id_dsa): <span class="comment">##指定key存放位置，可以直接回车。</span></span><br><span class="line">Created directory <span class="string">&#x27;/root/.ssh&#x27;</span>.</span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): <span class="comment">##输入密钥锁，可以直接回车。</span></span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /niu/.ssh/id_dsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /niu/.ssh/id_dsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">64:47:0d:9c:ab:8f:1e:7e:5a:b0:25:64:55:23:06:3a niu@centos6.7-mupan</span><br><span class="line">The key<span class="string">&#x27;s randomart image is:</span></span><br><span class="line"><span class="string">+--[ DSA 1024]----+</span></span><br><span class="line"><span class="string">|        .o*=o    |</span></span><br><span class="line"><span class="string">|       . +o...   |</span></span><br><span class="line"><span class="string">|      E = ..     |</span></span><br><span class="line"><span class="string">|       * ..      |</span></span><br><span class="line"><span class="string">|        S..      |</span></span><br><span class="line"><span class="string">|        .=       |</span></span><br><span class="line"><span class="string">|        oo.      |</span></span><br><span class="line"><span class="string">|       ..oo      |</span></span><br><span class="line"><span class="string">|       .+o       |</span></span><br><span class="line"><span class="string">+-----------------+</span></span><br></pre></td></tr></table></figure>

<h3 id="在服务器上安装公钥并设置权限"><a href="#在服务器上安装公钥并设置权限" class="headerlink" title="在服务器上安装公钥并设置权限"></a>在服务器上安装公钥并设置权限</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> .ssh/</span><br><span class="line"><span class="built_in">cat</span> id_dsa.pub &gt;&gt; authorized_keys</span><br><span class="line"><span class="built_in">chmod</span> 600 authorized_keys</span><br><span class="line"><span class="built_in">chmod</span> 700 ~/.ssh</span><br></pre></td></tr></table></figure>

<p>编辑<code>/etc/ssh/sshd_config</code>启用密钥登录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RSAAuthentication <span class="built_in">yes</span></span><br><span class="line">PubkeyAuthentication <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<h3 id="将公钥下载到客户端，然后使用公钥登录"><a href="#将公钥下载到客户端，然后使用公钥登录" class="headerlink" title="将公钥下载到客户端，然后使用公钥登录"></a>将公钥下载到客户端，然后使用公钥登录</h3><p><img src="http://oi3tsepsh.bkt.clouddn.com/14858277547473.jpg"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.biglittleant.cn/2017/01/11/haproxy-install/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Big Little Ant">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Big Little Ant">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Big Little Ant">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/01/11/haproxy-install/" class="post-title-link" itemprop="url">haproxy快速入门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-01-11 18:45:14" itemprop="dateCreated datePublished" datetime="2017-01-11T18:45:14+08:00">2017-01-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-09-16 17:29:50" itemprop="dateModified" datetime="2020-09-16T17:29:50+08:00">2020-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/haproxy/" itemprop="url" rel="index"><span itemprop="name">haproxy</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="haproxy简介"><a href="#haproxy简介" class="headerlink" title="haproxy简介"></a>haproxy简介</h2><p>HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。</p>
<h2 id="haproxy的优势"><a href="#haproxy的优势" class="headerlink" title="haproxy的优势"></a>haproxy的优势</h2><ul>
<li>专门做反向代理负载均衡</li>
<li>有八种以上的负载均衡算法</li>
<li>性能大于等于 nginx</li>
<li>支持动态管理，通过haproxy的sock进行通信，可以进行管理。</li>
<li>有比较丰富的dashboard页面。</li>
<li>有比较强大的七层功能。</li>
</ul>
<h2 id="haproxy实战"><a href="#haproxy实战" class="headerlink" title="haproxy实战"></a>haproxy实战</h2><h3 id="haproxy基础环境准备"><a href="#haproxy基础环境准备" class="headerlink" title="haproxy基础环境准备"></a>haproxy基础环境准备</h3><p>实验环境</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>ip address</th>
<th>操作系统</th>
</tr>
</thead>
<tbody><tr>
<td>linux-node1.example.com</td>
<td>192.168.56.11</td>
<td>centos7</td>
</tr>
<tr>
<td>linux-node2.example.com</td>
<td>192.168.56.12</td>
<td>centos7</td>
</tr>
</tbody></table>
<p>安装EPEL及基础软件包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh http://mirrors.aliyun.com/epel/epel-release-latest-7.noarch.rpm</span><br><span class="line">yum install -y gcc glibc gcc-c++ make screen tree lrzsz</span><br></pre></td></tr></table></figure>

<p>使用两个Apache的8080端口作为后端真实服务器</p>
<p>linux-node1.example.com</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]<span class="comment"># yum install -y httpd</span></span><br><span class="line">[root@linux-node1 ~]<span class="comment"># sed -i &#x27;s/Listen 80/Listen 8080/g&#x27; /etc/httpd/conf/httpd.conf</span></span><br><span class="line">[root@linux-node1 ~]<span class="comment"># systemctl start httpd</span></span><br><span class="line">[root@linux-node1 ~]<span class="comment"># echo &quot;linux-node1.example.com&quot; &gt; /var/www/html/index.html</span></span><br><span class="line">[root@linux-node1 ~]<span class="comment"># curl http://192.168.56.11:8080/</span></span><br><span class="line">linux-node1.example.com</span><br></pre></td></tr></table></figure>

<p>linux-node2.example.com</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node2 ~]<span class="comment"># yum install -y httpd</span></span><br><span class="line">[root@linux-node2 ~]<span class="comment"># sed -i &#x27;s/Listen 80/Listen 8080/g&#x27; /etc/httpd/conf/httpd.conf</span></span><br><span class="line">[root@linux-node2 ~]<span class="comment"># systemctl start httpd</span></span><br><span class="line">[root@linux-node2 ~]<span class="comment"># echo &quot;linux-node2.example.com&quot; &gt; /var/www/html/index.html</span></span><br><span class="line">[root@linux-node2 ~]<span class="comment"># curl http://192.168.56.12:8080/</span></span><br><span class="line">linux-node2.example.com</span><br></pre></td></tr></table></figure>

<p>让本机服务器监听非本机的IP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_nonlocal_bind = 1</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h3 id="Haproxy源码编译安装"><a href="#Haproxy源码编译安装" class="headerlink" title="Haproxy源码编译安装"></a>Haproxy源码编译安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# cd /usr/local/src</span><br><span class="line">[root@linux-node1 src]# wget http://www.haproxy.org/download/1.6/src/haproxy-1.6.3.tar.gz</span><br><span class="line">[root@linux-node1 src]# tar zxf haproxy-1.6.3.tar.gz</span><br><span class="line">[root@linux-node1 src]# cd haproxy-1.6.3</span><br><span class="line">[root@linux-node1 src]# make TARGET=linux2628 PREFIX=/usr/local/haproxy-1.6.3</span><br><span class="line">[root@linux-node1 src]# make install</span><br><span class="line">[root@linux-node1 ~]# cp /usr/local/sbin/haproxy /usr/sbin/</span><br><span class="line">[root@linux-node1 ~]# haproxy -v</span><br><span class="line">HA-Proxy version 1.6.3 2015/12/25</span><br><span class="line">Copyright 2000-2015 Willy Tarreau &lt;willy@haproxy.org&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Haproxy启动脚本"><a href="#Haproxy启动脚本" class="headerlink" title="Haproxy启动脚本"></a>Haproxy启动脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# cd /usr/local/src/haproxy-1.6.3</span><br><span class="line">[root@linux-node1 haproxy-1.6.3]# cp examples/haproxy.init /etc/init.d/haproxy</span><br><span class="line">[root@linux-node1 haproxy-1.6.3]# chmod 755 /etc/init.d/haproxy</span><br></pre></td></tr></table></figure>

<h3 id="Haproxy配置文件"><a href="#Haproxy配置文件" class="headerlink" title="Haproxy配置文件"></a>Haproxy配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# useradd -r haproxy</span><br><span class="line">[root@linux-node1 ~]# mkdir /etc/haproxy</span><br><span class="line">[root@linux-node1 ~]# mkdir /var/lib/haproxy</span><br><span class="line">[root@linux-node1 ~]# mkdir /var/run/haproxy</span><br></pre></td></tr></table></figure>

<h3 id="haproxy日志文件配置"><a href="#haproxy日志文件配置" class="headerlink" title="haproxy日志文件配置"></a>haproxy日志文件配置</h3><p>haproxy默认使用系统的 <code>local3.* </code> 来存储日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rsyslog.conf</span><br><span class="line"></span><br><span class="line">local3.*               /var/log/haproxy.log</span><br><span class="line"></span><br><span class="line">systemctl restart rsyslog.service</span><br></pre></td></tr></table></figure>

<h3 id="haproxy配置文件解读"><a href="#haproxy配置文件解读" class="headerlink" title="haproxy配置文件解读"></a>haproxy配置文件解读</h3><p>haproxy的配置文件分为五大块</p>
<ul>
<li>global (全局)</li>
<li>defaults （默认）</li>
<li>listen （监听的配置）</li>
<li>frontend （前端）name vip</li>
<li>backend（后端）name server 列表</li>
</ul>
<h4 id="下面来分别讲解各个配置文件的定义"><a href="#下面来分别讲解各个配置文件的定义" class="headerlink" title="下面来分别讲解各个配置文件的定义"></a>下面来分别讲解各个配置文件的定义</h4><h4 id="global-全局"><a href="#global-全局" class="headerlink" title="global (全局)"></a>global (全局)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">global ##定义这是全局配置</span><br><span class="line">   log 127.0.0.1 local3 info</span><br><span class="line">   ###全局的日志配置，使用log关键字，指定使用127.0.0.1上的syslog服务中的local0日志设备，记录日志等级为info的日志。</span><br><span class="line">   chroot /var/lib/haproxy</span><br><span class="line">   ##使用chroot的模式运行haproxy</span><br><span class="line">   user haproxy</span><br><span class="line">   group haproxy</span><br><span class="line">   ##设置运行haproxy的用户和组，可以使用uid gid 关键字代替。</span><br><span class="line">   daemon</span><br><span class="line">   ##以守护进程的方式运行</span><br></pre></td></tr></table></figure>

<h4 id="defaults-（默认）"><a href="#defaults-（默认）" class="headerlink" title="defaults （默认）"></a>defaults （默认）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">defaults</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#defaults模块标识</span></span></span><br><span class="line">   log global</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="comment">#使用global中定义的日志</span></span></span><br><span class="line">   mode http</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="comment">#mode 语法： mode&#123;http|tcp|health&#125; ， http是七层模式，tcp是四层模式，health是检查检测。返回OK。</span></span></span><br><span class="line">   option httplog</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="comment">#启用日志记录HTTP请求，默认haproxy日志记录是不记录HTTP请求的，只记录“时间[jan 5 13：23：46] 日志服务器[127.0.0.1] 实例名以及PID [haproxy[25218]] 信息[proxy http 80 in stoped]” ,日志格式很简单。</span></span></span><br><span class="line">   option dontlognull</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="comment">#启用该项，日志中将不会记录空连接，所谓空连接就是在上游的负载均衡器或者监听系统为l探测该服务是否存活可用时，需要定期的连接或者获取某一股东的组件或页面，或者探测扫描端口是否在监听或开放等动作被称为空连接。官方文档中标注，如果该服务上游没有其他的负载均衡器的话，建议不要使用该参数。因为互联网上的恶意扫描或其他动作就不会被记录。</span></span></span><br><span class="line"></span><br><span class="line">   timeout connect 5000</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="comment">#设置成功连接到一台服务器的最长等待时间。默认单位是毫秒，新颁布的haproxy使用timeout connect 代替。该参数向换兼容。</span></span></span><br><span class="line">   timeout client 50000</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="comment">#设置连接客户端发送数据时的成功连接最长等待时间，默认单位是毫秒。</span></span></span><br><span class="line">   timeout server 50000</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="comment">#设置服务器端回应客户端数据发送的最长等待时间，默认单位是毫秒</span></span></span><br></pre></td></tr></table></figure>


<h4 id="listen-（监听页面的配置）"><a href="#listen-（监听页面的配置）" class="headerlink" title="listen （监听页面的配置）"></a>listen （监听页面的配置）</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">listen stats</span><br><span class="line"><span class="comment">##定义页面监控的名称</span></span><br><span class="line">    mode http</span><br><span class="line">    <span class="comment">##http的7层模式</span></span><br><span class="line">    <span class="built_in">bind</span> 0.0.0.0:8888</span><br><span class="line">    <span class="comment">##服务器监听端口</span></span><br><span class="line">    stats <span class="built_in">enable</span></span><br><span class="line">    <span class="comment">##开启状态模块</span></span><br><span class="line">    stats uri     /haproxy-status</span><br><span class="line">    <span class="comment">##状态模块的URI</span></span><br><span class="line">    stats auth    haproxy:haproxy</span><br><span class="line">    <span class="comment">##状态模块登录的用户名和密码</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="frontend-（前端）name-vip"><a href="#frontend-（前端）name-vip" class="headerlink" title="frontend （前端）name vip"></a>frontend （前端）name vip</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frontend http_front</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义前端的名称</span></span><br><span class="line">   bind *:80</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">服务器对外监听的端口，类似于lvs的vip端口</span></span><br><span class="line">   stats uri /haproxy?stats</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">状态页面定义</span></span><br><span class="line">   default_backend http_back</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">对应的后端服务名称</span></span><br></pre></td></tr></table></figure>
<h4 id="backend（后端）name-server-列表"><a href="#backend（后端）name-server-列表" class="headerlink" title="backend（后端）name server 列表"></a>backend（后端）name server 列表</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">backend http_back</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">后端服务的名称</span></span><br><span class="line">   balance roundrobin</span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash">定义轮询算法，roundrobin 轮询，<span class="built_in">source</span>  源IPhash，leastconn 最小连接数，这里只列举了常用的三个。</span></span><br><span class="line"></span><br><span class="line">    option forwardfor header X-REAL-IP</span><br><span class="line">    option httpchk HEAD / HTTP/1.0</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#haproxy的健康检查，如果这两行被禁用，就是四次检测。</span></span></span><br><span class="line">    server web-node1  192.168.56.11:8080 check inter 2000 rise 30 fall 3</span><br><span class="line">    server web-node2  192.168.56.12:8080 check inter 2000 rise 30 fall 3</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#后端真实ip配置，check 表示开启健康检查，inter  2000ms 每隔多长时间检查一次，rise  30    服务可用的连续次数，连续30次可用，在把你加进来，fall 3  失败三次 就把你踢出去。</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="完整的haproxy配置文件"><a href="#完整的haproxy配置文件" class="headerlink" title="完整的haproxy配置文件"></a>完整的haproxy配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">   log 127.0.0.1 local3 info</span><br><span class="line">   chroot /var/lib/haproxy</span><br><span class="line">   user haproxy</span><br><span class="line">   group haproxy</span><br><span class="line">   daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">   log global</span><br><span class="line">   mode http</span><br><span class="line">   option httplog</span><br><span class="line">   option dontlognull</span><br><span class="line">   timeout connect 5000</span><br><span class="line">   timeout client 50000</span><br><span class="line">   timeout server 50000</span><br><span class="line"></span><br><span class="line">frontend http_front</span><br><span class="line">   bind *:80</span><br><span class="line">   stats uri /haproxy?stats</span><br><span class="line">   default_backend http_back</span><br><span class="line"></span><br><span class="line">backend http_back</span><br><span class="line">   balance roundrobin</span><br><span class="line">   option httpchk GET /index.html</span><br><span class="line">   option httpchk GET /</span><br><span class="line">   server linux-node1 192.168.56.11:8080 check</span><br><span class="line">   server linux-node2 192.168.56.12:8080 check</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="haproxy的ACL控制。"><a href="#haproxy的ACL控制。" class="headerlink" title="haproxy的ACL控制。"></a>haproxy的ACL控制。</h3><p>推荐生产上不要使用ACL访问控制。所有这里就没有研究。如果感兴趣的可以自行百度。</p>
<h3 id="haproxy动态管理"><a href="#haproxy动态管理" class="headerlink" title="haproxy动态管理"></a>haproxy动态管理</h3><h4 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h4><p>可以listen模式中开启<code>stats admin if TRUE           #开启页面管理</code> 通过图形界面管理服务器上下线。</p>
<h4 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h4><p>使用socat 管理haproxy服务器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在global开启socket</span></span><br><span class="line">global</span><br><span class="line">    stats  socket /var/run/haproxy.sock mode 600 level admin</span><br><span class="line">    stats timeout 2m</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装socat管理软件</span></span><br><span class="line">yum install socat</span><br><span class="line">使用socat管理haproxy</span><br><span class="line">socat /var/run/haproxy.sock stdio</span><br><span class="line">基本用法：</span><br><span class="line">echo &quot;help&quot;| socat stdio /var/run/haproxy.sock #socat常用命令</span><br><span class="line">echo &quot;show info &quot;| socat stdio /var/run/haproxy.sock # 显示dashboad 的信息。</span><br><span class="line">echo &quot;show pools &quot;| socat stdio /var/run/haproxy.sock #显示内部资源池的状态</span><br><span class="line">echo &quot;show stat &quot;| socat stdio /var/run/haproxy.sock # 显示前后端服务器的状态</span><br><span class="line"></span><br><span class="line">echo &quot;set maxconn&quot;| socat stdio /var/run/haproxy.sock #修改最大连接数</span><br><span class="line">echo &quot;disable server  backend_www_example_com/web-node2  &quot;| socat stdio /var/run/haproxy.sock # 关闭 web-node2 的服务器</span><br><span class="line">echo &quot;disable server  backend_www_docker_nginx/docker-web2  &quot;| socat stdio /var/run/haproxy.sock # 关闭 web-node2 的服务器</span><br><span class="line">echo &quot;enable server  backend_www_docker_nginx/docker-web2  &quot;| socat stdio /var/run/haproxy.sock # 开启 web-node2 的服务器</span><br><span class="line"></span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Big Little Ant</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
